<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kovil Valikatti - Temple Navigation Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-saffron: #FF6B35;
            --secondary-gold: #FFD700;
            --background-cream: #FFF8E7;
            --text-dark: #3E2723;
            --text-secondary: #6D4C41;
            --card-white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.15);
            --border-light: #E0E0E0;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --error-red: #F44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-cream);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .tamil {
            font-family: 'Noto Sans Tamil', sans-serif;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-saffron), #FF8A65);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo i {
            margin-right: 0.5rem;
            font-size: 1.4rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-saffron);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--primary-saffron);
            border: 2px solid var(--primary-saffron);
        }

        .btn-ghost {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Home Screen */
        .home-section {
            padding: 2rem 0;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .action-card {
            background: var(--card-white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-saffron);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--primary-saffron);
            margin-bottom: 1rem;
        }

        .action-card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Nearest Temples */
        .nearest-temples {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .map-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .temple-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .temple-card {
            background: var(--card-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .temple-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .temple-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .temple-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .temple-location {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .temple-info {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--secondary-gold);
        }

        .distance {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .temple-actions {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
        }

        /* Search Bar */
        .search-section {
            margin-bottom: 2rem;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--card-white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-saffron);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--card-white);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--primary-saffron);
            color: white;
            border-color: var(--primary-saffron);
        }

        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .map-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--primary-saffron);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tour Circuits */
        .circuit-card {
            background: linear-gradient(135deg, var(--primary-saffron), var(--secondary-gold));
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .circuit-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .circuit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .circuit-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .circuit-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-white);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            text-decoration: none;
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--primary-saffron);
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .nav-item span {
            font-size: 0.7rem;
        }

        /* Screen Containers */
        .screen {
            display: none;
            min-height: calc(100vh - 140px);
            padding-bottom: 80px;
        }

        .screen.active {
            display: block;
        }

        /* Temple Detail Screen */
        .temple-detail {
            max-width: 800px;
            margin: 0 auto;
        }

        .temple-detail-header {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .temple-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .temple-detail-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .temple-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .meta-item {
            text-align: center;
            padding: 1rem;
            background: var(--background-cream);
            border-radius: 8px;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-saffron);
        }

        .meta-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .temple-actions-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn-navigate {
            background: var(--success-green);
            color: white;
        }

        .action-btn-call {
            background: var(--primary-saffron);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .action-card {
                padding: 1.5rem;
            }
            
            .action-card i {
                font-size: 2.5rem;
            }
            
            .temple-grid {
                grid-template-columns: 1fr;
            }
            
            .temple-card {
                margin-bottom: 1rem;
            }
            
            .temple-header {
                padding: 1rem;
            }
            
            .temple-name {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .temple-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .filters {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .filter-btn {
                white-space: nowrap;
                min-width: max-content;
            }
            
            .temple-actions-detail {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .action-btn {
                padding: 0.875rem;
                font-size: 0.95rem;
            }
            
            .temple-detail-header {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .temple-detail-title {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            .temple-meta {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .meta-item {
                padding: 0.75rem;
            }
            
            .settings-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .circuit-card {
                padding: 1.5rem;
            }
            
            .circuit-title {
                font-size: 1.1rem;
                line-height: 1.3;
            }
            
            .circuit-temple-item {
                padding: 0.75rem;
            }
            
            .header-content {
                padding: 0 0.5rem;
            }
            
            .container {
                padding: 0 0.75rem;
            }
            
            .search-container {
                max-width: 100%;
                margin: 0;
            }
            
            .map-container {
                height: 300px;
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .temple-meta {
                grid-template-columns: 1fr;
            }
            
            .hero h1 {
                font-size: 1.75rem;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .action-card {
                padding: 1.25rem;
            }
        }

        /* Festival Calendar Styles */
        .festival-card {
            background: var(--card-white);
            border-left: 4px solid var(--primary-saffron);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .festival-date {
            color: var(--primary-saffron);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .festival-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .festival-temples {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            display: inline-block;
            font-weight: 500;
        }

        /* Tour Circuit Detail */
        .circuit-detail {
            max-width: 800px;
            margin: 0 auto;
        }

        .circuit-overview {
            background: var(--card-white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .circuit-temples-list {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .circuit-temple-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .circuit-temple-item:hover {
            background: var(--background-cream);
        }

        .circuit-temple-item:last-child {
            border-bottom: none;
        }

        .temple-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-saffron);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
        }

        /* Settings Screen */
        .settings-section {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border-light);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: var(--primary-saffron);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        /* Location Status Indicators */
        .location-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .location-available {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
        }

        .location-unavailable {
            background: rgba(158, 158, 158, 0.1);
            color: #9E9E9E;
        }

        /* Crowd Indicator */
        .crowd-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: var(--background-cream);
        }

        .crowd-low { color: var(--success-green); }
        .crowd-medium { color: var(--warning-orange); }
        .crowd-high { color: var(--error-red); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-om"></i>
                <span id="app-title">Kovil Valikatti</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-ghost" id="language-toggle">
                    <i class="fas fa-language"></i>
                    <span id="lang-text">தமிழ்</span>
                </button>
<!-- Location button removed - auto-fetching location instead -->
            </div>
        </div>
    </header>

    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero">
                <h1 id="hero-title">Discover Sacred Temples</h1>
                <p id="hero-subtitle">Find temples, plan pilgrimages, and explore Tamil Nadu's spiritual heritage</p>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <div class="action-card" id="nearest-action">
                    <i class="fas fa-location-arrow"></i>
                    <h3 id="nearest-title">Nearest Temples</h3>
                    <p id="nearest-desc">Discover 588 Tamil Nadu temples (127 with navigation)</p>
                </div>
                <div class="action-card" id="map-action">
                    <i class="fas fa-map"></i>
                    <h3 id="map-title">Temple Map</h3>
                    <p id="map-desc">Explore temples on interactive map</p>
                </div>
                <div class="action-card" id="tours-action">
                    <i class="fas fa-route"></i>
                    <h3 id="tours-title">Tour Circuits</h3>
                    <p id="tours-desc">Sacred journey routes</p>
                </div>
                <div class="action-card" id="festivals-action">
                    <i class="fas fa-calendar-alt"></i>
                    <h3 id="festivals-title">Festivals</h3>
                    <p id="festivals-desc">Tamil calendar events</p>
                </div>
            </section>

            <!-- Search Section -->
            <section class="search-section">
                <div class="search-container">
                    <input type="text" class="search-input" id="main-search" placeholder="Search temples...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </section>

            <!-- Nearest Temples -->
            <section class="nearest-temples">
                <div class="section-header">
                    <h2 class="section-title" id="nearby-section-title">Nearby Temples</h2>
                    <button class="btn btn-secondary" id="view-all-nearby"><span id="view-all-text">View All</span></button>
                </div>
                <div class="temple-grid" id="nearby-temples-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Finding nearby temples...</span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Discovery Screen -->
    <div id="discovery-screen" class="screen">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title" id="discovery-title">Temple Discovery</h2>
                <div class="map-toggle">
                    <button class="btn btn-secondary" id="list-view-btn">
                        <i class="fas fa-list"></i> <span id="list-view-text">List</span>
                    </button>
                    <button class="btn btn-primary" id="map-view-btn">
                        <i class="fas fa-map"></i> <span id="map-view-text">Map</span>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <button class="filter-btn active" data-filter="all" id="filter-all-temples">All Temples</button>
                <button class="filter-btn" data-filter="location" id="filter-with-location">With Location 📍</button>
                <button class="filter-btn" data-filter="shiva" id="filter-shiva">Shiva</button>
                <button class="filter-btn" data-filter="vishnu" id="filter-vishnu">Vishnu</button>
                <button class="filter-btn" data-filter="hanuman" id="filter-hanuman">Hanuman</button>
                <button class="filter-btn" data-filter="goddess" id="filter-goddess">Goddess</button>
            </div>

            <!-- Map Container -->
            <div class="map-container" id="temple-map" style="display: none;">
                <!-- Leaflet map will be initialized here -->
            </div>

            <!-- Temple List -->
            <div class="temple-grid" id="discovery-temples-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <span id="loading-temples-text">Loading temples...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Temple Detail Screen -->
    <div id="temple-detail-screen" class="screen">
        <div class="container">
            <div class="temple-detail">
                <div class="temple-detail-header">
                    <h1 class="temple-detail-title" id="temple-detail-name">Temple Name</h1>
                    <p class="temple-detail-subtitle" id="temple-detail-location">Location</p>
                    
                    <div class="temple-meta">
                        <div class="meta-item">
                            <div class="meta-value" id="temple-distance">2.3 km</div>
                            <div class="meta-label" id="distance-label">Distance</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-value" id="temple-deity">Shiva</div>
                            <div class="meta-label" id="deity-label">Deity</div>
                        </div>
                    </div>
                </div>

                <div class="temple-actions-detail">
                    <button class="action-btn action-btn-navigate" id="navigate-btn">
                        <i class="fas fa-directions"></i>
                        <span id="navigate-btn-text">Navigate</span>
                    </button>
                    <button class="action-btn action-btn-call" id="call-btn">
                        <i class="fas fa-phone"></i>
                        <span id="call-btn-text">Call Temple</span>
                    </button>
                </div>

                <div class="temple-detail-content">
                    <div class="settings-section">
                        <h3 id="temple-info-header">Temple Information</h3>
                        <div id="temple-address"></div>
                        <div id="temple-location-status"></div>
                        <div id="temple-crowd-info"></div>
                        <div id="temple-timings"></div>
                        <div id="temple-website"></div>
                    </div>
                    
                    <div class="settings-section" id="tamil-name-section" style="display: none;">
                        <h3>Tamil Name</h3>
                        <div id="temple-tamil-name" class="tamil" style="font-size: 1.2rem; font-weight: 600;"></div>
                    </div>

                    <div class="settings-section" id="popular-times-section" style="display: none;">
                        <h3 id="popular-times-header">Popular Times</h3>
                        <div id="temple-popular-times"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tours Screen -->
    <div id="tours-screen" class="screen">
        <div class="container">
            <h2 class="section-title" id="tours-section-title">Sacred Tour Circuits</h2>
            <div id="tour-circuits-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading tour circuits...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tour Detail Screen -->
    <div id="tour-detail-screen" class="screen">
        <div class="container">
            <div class="circuit-detail">
                <div class="circuit-overview">
                    <h1 id="circuit-name">Circuit Name</h1>
                    <p id="circuit-description">Circuit Description</p>
                    <div class="circuit-meta">
                        <span><i class="fas fa-map-marked-alt"></i> <span id="circuit-temples-count">0</span> Temples</span>
                        <span><i class="fas fa-route"></i> <span id="circuit-distance">0</span> km</span>
                        <span><i class="fas fa-clock"></i> <span id="circuit-duration">0</span> hours</span>
                    </div>
                    <button class="btn btn-primary mt-2" id="start-circuit-btn">
                        <i class="fas fa-play"></i>
                        Start Circuit
                    </button>
                </div>
                <div class="circuit-temples-list">
                    <h3>Temples in Circuit</h3>
                    <div id="circuit-temples-container">
                        <!-- Circuit temples will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Festivals Screen -->
    <div id="festivals-screen" class="screen">
        <div class="container">
            <h2 class="section-title" id="festivals-section-title">Festival Calendar</h2>
            
            <!-- Festival Type Filters -->
            <div class="filters" style="margin-bottom: 1.5rem;">
                <button class="filter-btn active" data-festival-type="all" id="festival-filter-all">All</button>
                <button class="filter-btn" data-festival-type="major" id="festival-filter-major">Major Festivals</button>
                <button class="filter-btn" data-festival-type="pradosham" id="festival-filter-pradosham">Pradosham</button>
                <button class="filter-btn" data-festival-type="ekadashi" id="festival-filter-ekadashi">Ekadashi</button>
                <button class="filter-btn" data-festival-type="pournami" id="festival-filter-pournami">Full Moon</button>
                <button class="filter-btn" data-festival-type="amavasya" id="festival-filter-amavasya">New Moon</button>
            </div>
            
            <!-- Festival Counter -->
            <div style="text-align: center; margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                <span id="festival-count">Showing all 88 festivals</span>
            </div>
            
            <div id="festivals-list">
                <!-- Festivals will be loaded dynamically -->
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading festivals...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen removed - language toggle in header is sufficient -->

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-screen="home-screen">
            <i class="fas fa-home"></i>
            <span id="nav-home">Home</span>
        </a>
        <a href="#" class="nav-item" data-screen="discovery-screen">
            <i class="fas fa-search"></i>
            <span id="nav-discover">Discover</span>
        </a>
        <a href="#" class="nav-item" data-screen="tours-screen">
            <i class="fas fa-route"></i>
            <span id="nav-tours">Tours</span>
        </a>
        <a href="#" class="nav-item" data-screen="festivals-screen">
            <i class="fas fa-calendar"></i>
            <span id="nav-festivals">Festivals</span>
        </a>
        <!-- Settings tab removed - language toggle in header is sufficient -->
    </nav>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global App State
        const AppState = {
            temples: [],
            tourCircuits: [],
            currentLocation: { lat: 13.0827, lng: 80.2707 }, // Chennai default
            currentLanguage: 'en',
            currentScreen: 'home-screen',
            currentTemple: null,
            currentCircuit: null,
            map: null,
            userLocation: null
        };

        // Localization Data
        let localizationData = null;
        
        // Global Festival Data - Complete 88 festivals including monthly observances
        let allFestivals = [];
        
        // Load localization data from JSON file
        async function loadLocalizationData() {
            try {
                const response = await fetch('./app_strings.json');
                if (!response.ok) {
                    throw new Error(`Failed to load localization: ${response.status}`);
                }
                localizationData = await response.json();
                console.log('✅ Localization data loaded successfully');
                return localizationData;
            } catch (error) {
                console.error('❌ Failed to load localization data:', error);
                // Fallback to basic translations if JSON loading fails
                localizationData = {
                    languages: {
                        en: { name: 'English', code: 'en' },
                        ta: { name: 'தமிழ்', code: 'ta' }
                    },
                    strings: {
                        app_title: { en: 'Kovil Valikatti', ta: 'கோவில் வழிகாட்டி' },
                        hero_title: { en: 'Find Your Sacred Path', ta: 'உங்கள் புனித பாதையை கண்டுபிடியுங்கள்' }
                    }
                };
                return localizationData;
            }
        }
        
        // Enhanced temple name matching for Tamil searches
        function enhanceTempleSearchForTamil(temples) {
            return temples.map(temple => {
                // Create searchable Tamil keywords from English name
                const tamilKeywords = [];
                
                // Common temple name mappings
                const nameMap = {
                    'Shiva': 'சிவன்',
                    'Vishnu': 'விஷ்ணு',
                    'Murugan': 'முருகன்',
                    'Hanuman': 'ஹனுமான்',
                    'Ganesha': 'கணேசன்',
                    'Amman': 'அம்மன்',
                    'Perumal': 'பெருமாள்',
                    'Temple': 'கோவில்',
                    'Swamy': 'சுவாமி'
                };
                
                // Extract searchable terms from English name
                Object.keys(nameMap).forEach(english => {
                    if (temple.name.toLowerCase().includes(english.toLowerCase())) {
                        tamilKeywords.push(nameMap[english]);
                    }
                });
                
                // Add deity-specific Tamil terms
                if (temple.deity_type) {
                    const deityMap = {
                        'shiva': 'சிவன்',
                        'vishnu': 'விஷ்ணு',
                        'murugan': 'முருகன்',
                        'hanuman': 'ஹனுமான்',
                        'goddess': 'அம்மன்'
                    };
                    if (deityMap[temple.deity_type]) {
                        tamilKeywords.push(deityMap[temple.deity_type]);
                    }
                }
                
                // Return enhanced temple object with Tamil search terms
                return {
                    ...temple,
                    tamil_search_keywords: tamilKeywords.join(' ')
                };
            });
        }
        
        // Tamil month name translations
        function getTamilMonthName(englishMonth) {
            if (AppState.currentLanguage !== 'ta') return englishMonth;
            
            const tamilMonths = {
                'Margazhi': 'மார்கழி',
                'Thai': 'தை',
                'Masi': 'மாசி',
                'Panguni': 'பங்குனி',
                'Chithirai': 'சித்திரை',
                'Vaikasi': 'வைகாசி',
                'Aani': 'ஆனி',
                'Aadi': 'ஆடி',
                'Aavani': 'ஆவணி',
                'Purattasi': 'புரட்டாசி',
                'Aippasi': 'ஐப்பசி',
                'Karthigai': 'கார்த்திகை'
            };
            
            return tamilMonths[englishMonth] || englishMonth;
        }
        
        // Get localized string with fallback
        function getLocalizedString(key, lang = AppState.currentLanguage) {
            if (!localizationData || !localizationData.strings) {
                console.warn(`Localization data not loaded for key: ${key}`);
                return key; // Return key as fallback
            }
            
            // Handle nested keys like 'navigation.home'
            const keys = key.split('.');
            let current = localizationData.strings;
            
            for (const k of keys) {
                if (current && current[k]) {
                    current = current[k];
                } else {
                    console.warn(`Localization key not found: ${key}`);
                    return key;
                }
            }
            
            // Return the localized string for the current language
            if (current && current[lang]) {
                return current[lang];
            } else if (current && current.en) {
                // Fallback to English if current language not available
                return current.en;
            }
            
            console.warn(`No localization found for key: ${key} in language: ${lang}`);
            return key;
        }

        // Utility Functions
        function $(id) {
            return document.getElementById(id);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(km) {
            if (km < 1) {
                return `${Math.round(km * 1000)}m`;
            }
            return `${km.toFixed(1)}km`;
        }

        // Language Management
        function updateLanguage(lang) {
            AppState.currentLanguage = lang;
            localStorage.setItem('preferred-language', lang);
            
            if (!localizationData) {
                console.warn('Localization data not loaded yet');
                return;
            }
            
            // Update all translatable elements using new localization system
            updateUIStrings(lang);

            // Update body class for Tamil font
            if (lang === 'ta') {
                document.body.classList.add('tamil');
            } else {
                document.body.classList.remove('tamil');
            }
            
            // Refresh temple displays to show names in selected language
            if (AppState.currentScreen === 'home-screen') {
                loadNearbyTemples();
            } else if (AppState.currentScreen === 'discovery-screen') {
                loadDiscoveryTemples();
            }
            
            // Update current temple detail if showing
            if (AppState.currentScreen === 'temple-detail-screen' && AppState.currentTemple) {
                showTempleDetail(AppState.currentTemple.id);
            }
        }
        
        // Update all UI strings based on current language
        function updateUIStrings(lang) {
            // Header and main navigation
            const appTitle = $('app-title');
            if (appTitle) appTitle.textContent = getLocalizedString('app_title', lang);
            
            const heroTitle = $('hero-title');
            if (heroTitle) heroTitle.textContent = getLocalizedString('hero_title', lang);
            
            const heroSubtitle = $('hero-subtitle');
            if (heroSubtitle) heroSubtitle.textContent = getLocalizedString('hero_subtitle', lang);
            
            // Action cards
            const nearestTitle = $('nearest-title');
            if (nearestTitle) nearestTitle.textContent = getLocalizedString('nearest_temples', lang);
            
            const nearestDesc = $('nearest-desc');
            if (nearestDesc) nearestDesc.textContent = getLocalizedString('nearest_desc', lang);
            
            const mapTitle = $('map-title');
            if (mapTitle) mapTitle.textContent = getLocalizedString('temple_map', lang);
            
            const mapDesc = $('map-desc');
            if (mapDesc) mapDesc.textContent = getLocalizedString('temple_map_desc', lang);
            
            const toursTitle = $('tours-title');
            if (toursTitle) toursTitle.textContent = getLocalizedString('tour_circuits', lang);
            
            const toursDesc = $('tours-desc');
            if (toursDesc) toursDesc.textContent = getLocalizedString('tour_circuits_desc', lang);
            
            const festivalsTitle = $('festivals-title');
            if (festivalsTitle) festivalsTitle.textContent = getLocalizedString('festivals', lang);
            
            const festivalsDesc = $('festivals-desc');
            if (festivalsDesc) festivalsDesc.textContent = getLocalizedString('festivals_desc', lang);
            
            // Section titles
            const nearbySection = $('nearby-section-title');
            if (nearbySection) nearbySection.textContent = getLocalizedString('nearest_temples', lang);
            
            const discoveryTitle = $('discovery-title');
            if (discoveryTitle) discoveryTitle.textContent = getLocalizedString('navigation.discover', lang);
            
            // Discovery page list/map toggle
            const listViewText = $('list-view-text');
            if (listViewText) listViewText.textContent = getLocalizedString('buttons.list_view', lang) || 'List';
            
            const mapViewText = $('map-view-text');
            if (mapViewText) mapViewText.textContent = getLocalizedString('buttons.map_view', lang) || 'Map';
            
            // Discovery page filters
            const filterAllTemples = $('filter-all-temples');
            if (filterAllTemples) filterAllTemples.textContent = getLocalizedString('filters.all_temples', lang);
            
            const filterWithLocation = $('filter-with-location');
            if (filterWithLocation) filterWithLocation.textContent = getLocalizedString('filters.with_location', lang);
            
            const filterShiva = $('filter-shiva');
            if (filterShiva) filterShiva.textContent = getLocalizedString('filters.shiva', lang);
            
            const filterVishnu = $('filter-vishnu');
            if (filterVishnu) filterVishnu.textContent = getLocalizedString('filters.vishnu', lang);
            
            const filterHanuman = $('filter-hanuman');
            if (filterHanuman) filterHanuman.textContent = getLocalizedString('filters.hanuman', lang);
            
            const filterGoddess = $('filter-goddess');
            if (filterGoddess) filterGoddess.textContent = getLocalizedString('filters.goddess', lang);
            
            // Festival page filters with dynamic counts
            updateFestivalFilterCounts(lang);
            
            // Navigation menu
            const navHome = $('nav-home');
            if (navHome) navHome.textContent = getLocalizedString('navigation.home', lang);
            
            const navDiscover = $('nav-discover');
            if (navDiscover) navDiscover.textContent = getLocalizedString('navigation.discover', lang);
            
            const navTours = $('nav-tours');
            if (navTours) navTours.textContent = getLocalizedString('navigation.tours', lang);
            
            const navFestivals = $('nav-festivals');
            if (navFestivals) navFestivals.textContent = getLocalizedString('navigation.festivals', lang);
            
            const navSettings = $('nav-settings');
            if (navSettings) navSettings.textContent = getLocalizedString('navigation.settings', lang);
            
            // Section title updates for different screens
            const festivalsSectionTitle = $('festivals-section-title');
            if (festivalsSectionTitle) festivalsSectionTitle.textContent = getLocalizedString('navigation.festivals', lang);
            
            const toursSectionTitle = $('tours-section-title');
            if (toursSectionTitle) toursSectionTitle.textContent = getLocalizedString('navigation.tours', lang);
            
            // Language toggle button
            const langText = $('lang-text');
            if (langText) langText.textContent = getLocalizedString('buttons.language_switch', lang);
            
            // Search placeholder
            const searchInput = document.querySelector('input[placeholder]');
            if (searchInput) {
                searchInput.placeholder = getLocalizedString('search_placeholder', lang);
            }
            
            // Button texts
            const viewAllText = $('view-all-text');
            if (viewAllText) viewAllText.textContent = getLocalizedString('buttons.view_all', lang);
            
            // Loading states
            const loadingTemplesText = $('loading-temples-text');
            if (loadingTemplesText) loadingTemplesText.textContent = getLocalizedString('loading.temples', lang);
            
            // Settings screen translations
            updateSettingsStrings(lang);
        }
        
        // Update settings screen strings
        function updateSettingsStrings(lang) {
            const settingsTitle = $('settings-section-title');
            if (settingsTitle) {
                settingsTitle.textContent = getLocalizedString('settings', lang);
            }
            
            // Language & Region section
            const langRegionTitle = $('language-region-title');
            if (langRegionTitle) {
                langRegionTitle.textContent = getLocalizedString('settings_sections.language_region', lang);
            }
            
            const appLangTitle = $('app-language-title');
            if (appLangTitle) {
                appLangTitle.textContent = getLocalizedString('settings_sections.app_language', lang);
            }
            
            const tamilEnglishSubtitle = $('tamil-english-subtitle');
            if (tamilEnglishSubtitle) {
                tamilEnglishSubtitle.textContent = getLocalizedString('settings_sections.tamil_english', lang);
            }
            
            // Location & Navigation section
            const locationNavTitle = $('location-navigation-title');
            if (locationNavTitle) {
                locationNavTitle.textContent = getLocalizedString('settings_sections.location_navigation', lang);
            }
            
            const locationServicesTitle = $('location-services-title');
            if (locationServicesTitle) {
                locationServicesTitle.textContent = getLocalizedString('settings_sections.location_services', lang);
            }
            
            // Additional settings elements
            const findNearbySubtitle = $('find-nearby-temples-subtitle');
            if (findNearbySubtitle) {
                findNearbySubtitle.textContent = getLocalizedString('settings_sections.find_nearby_temples', lang);
            }
            
            const gpsNavTitle = $('gps-navigation-title');
            if (gpsNavTitle) {
                gpsNavTitle.textContent = getLocalizedString('settings_sections.gps_navigation', lang);
            }
            
            const openInMapsSubtitle = $('open-in-maps-subtitle');
            if (openInMapsSubtitle) {
                openInMapsSubtitle.textContent = getLocalizedString('settings_sections.open_in_maps', lang);
            }
            
            const notificationsTitle = $('notifications-title');
            if (notificationsTitle) {
                notificationsTitle.textContent = getLocalizedString('settings_sections.notifications', lang);
            }
            
            const festivalAlertsTitle = $('festival-alerts-title');
            if (festivalAlertsTitle) {
                festivalAlertsTitle.textContent = getLocalizedString('settings_sections.festival_alerts', lang);
            }
            
            const upcomingFestivalsSubtitle = $('upcoming-festivals-subtitle');
            if (upcomingFestivalsSubtitle) {
                upcomingFestivalsSubtitle.textContent = getLocalizedString('settings_sections.upcoming_festivals', lang);
            }
        }
        
        // Update festival filter buttons with dynamic counts
        function updateFestivalFilterCounts(lang) {
            if (!allFestivals || allFestivals.length === 0) return;
            
            // Calculate counts dynamically from festival data
            const totalCount = allFestivals.length;
            const majorCount = allFestivals.filter(f => f.type === 'major').length;
            const pradoshamCount = allFestivals.filter(f => f.type === 'pradosham').length;
            const ekadasiCount = allFestivals.filter(f => f.type === 'ekadashi').length;
            const pournamiCount = allFestivals.filter(f => f.type === 'pournami').length;
            const amavasayaCount = allFestivals.filter(f => f.type === 'amavasya').length;
            
            // Update filter button text with counts
            const festivalFilterAll = $('festival-filter-all');
            if (festivalFilterAll) {
                const text = getLocalizedString('festival_filters.all_festivals', lang);
                festivalFilterAll.textContent = `${text} (${totalCount})`;
            }
            
            const festivalFilterMajor = $('festival-filter-major');
            if (festivalFilterMajor) {
                const text = getLocalizedString('festival_filters.major_festivals', lang);
                festivalFilterMajor.textContent = `${text} (${majorCount})`;
            }
            
            const festivalFilterPradosham = $('festival-filter-pradosham');
            if (festivalFilterPradosham) {
                const text = getLocalizedString('festival_filters.pradosham', lang);
                festivalFilterPradosham.textContent = `${text} (${pradoshamCount})`;
            }
            
            const festivalFilterEkadashi = $('festival-filter-ekadashi');
            if (festivalFilterEkadashi) {
                const text = getLocalizedString('festival_filters.ekadashi', lang);
                festivalFilterEkadashi.textContent = `${text} (${ekadasiCount})`;
            }
            
            const festivalFilterPournami = $('festival-filter-pournami');
            if (festivalFilterPournami) {
                const text = getLocalizedString('festival_filters.full_moon', lang);
                festivalFilterPournami.textContent = `${text} (${pournamiCount})`;
            }
            
            const festivalFilterAmavasya = $('festival-filter-amavasya');
            if (festivalFilterAmavasya) {
                const text = getLocalizedString('festival_filters.new_moon', lang);
                festivalFilterAmavasya.textContent = `${text} (${amavasayaCount})`;
            }
        }

        // Translation Helper Functions
        function getLocalizedDistrict(district) {
            if (!district) return '';
            // Convert district name to key format: "Chennai District" -> "chennai_district"
            const key = district.toLowerCase().replace(/ /g, '_');
            const translated = getLocalizedString(`districts.${key}`, AppState.currentLanguage);
            return translated || district; // Fallback to original if no translation found
        }
        
        function formatDistance(km) {
            if (!km && km !== 0) return '';
            // Round to nearest km - no decimals for distances
            const roundedKm = Math.round(km);
            const unit = getLocalizedString('units.km', AppState.currentLanguage);
            return `${roundedKm} ${unit}`;
        }
        
        function formatDistanceAway(km) {
            if (!km && km !== 0) return '';
            // Round to nearest km - no decimals for distances
            const roundedKm = Math.round(km);
            const template = getLocalizedString('units.km_away', AppState.currentLanguage);
            return template.replace('{distance}', roundedKm);
        }
        
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 6) return getLocalizedString('timings.night', AppState.currentLanguage);
            else if (hour < 12) return getLocalizedString('timings.morning', AppState.currentLanguage);
            else if (hour < 16) return getLocalizedString('timings.afternoon', AppState.currentLanguage);
            else if (hour < 20) return getLocalizedString('timings.evening', AppState.currentLanguage);
            else return getLocalizedString('timings.night', AppState.currentLanguage);
        }
        
        function formatOpenStatus(isOpen) {
            if (isOpen) {
                return getLocalizedString('timings.open_now', AppState.currentLanguage);
            } else {
                return getLocalizedString('timings.closed_now', AppState.currentLanguage);
            }
        }
        
        function formatRating(rating, reviewCount) {
            if (!rating) return '';
            const starsText = getLocalizedString('ratings.stars', AppState.currentLanguage).replace('{rating}', rating);
            if (reviewCount) {
                const reviewsText = getLocalizedString('ratings.reviews', AppState.currentLanguage).replace('{count}', reviewCount);
                return `${starsText} (${reviewsText})`;
            }
            return starsText;
        }
        
        function formatPhotos(count) {
            if (!count) return '';
            return getLocalizedString('ratings.photos', AppState.currentLanguage).replace('{count}', count);
        }
        
        function getLocalizedAction(action) {
            return getLocalizedString(`actions.${action}`, AppState.currentLanguage) || action;
        }
        
        function getLocalizedMessage(messageKey) {
            return getLocalizedString(`messages.${messageKey}`, AppState.currentLanguage) || messageKey;
        }
        
        function getLocalizedDeity(deityType) {
            if (!deityType) return getLocalizedString('deity_types.temple', AppState.currentLanguage) || 'Temple';
            const key = deityType.toLowerCase();
            const translated = getLocalizedString(`deity_types.${key}`, AppState.currentLanguage);
            return translated || (deityType.charAt(0).toUpperCase() + deityType.slice(1));
        }
        
        // Auto-fetch location on load
        function autoFetchLocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        AppState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        AppState.currentLocation = AppState.userLocation;
                        
                        // Refresh temples with actual location
                        loadNearbyTemples();
                        if (AppState.currentScreen === 'discovery-screen') {
                            loadDiscoveryTemples();
                        }
                    },
                    (error) => {
                        console.log('Using default Chennai location');
                        // Continue with default location silently
                    }
                );
            }
        }

        // Temple Data Loading
        async function loadTempleData() {
            try {
                showLoading($('nearby-temples-grid'), getLocalizedString('loading.temples'));
                
                // Log the URL being fetched for debugging
                const dataUrl = './temple_data.json';
                console.log('Fetching temple data from:', dataUrl);
                console.log('Current page URL:', window.location.href);
                
                const response = await fetch(dataUrl);
                
                if (!response.ok) {
                    console.error('Failed to load temple data:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.app_temples) {
                    throw new Error('Invalid temple data format');
                }
                
                // Load and enhance temples with Tamil search terms
                AppState.temples = enhanceTempleSearchForTamil(data.app_temples || []);
                AppState.tourCircuits = data.tour_circuits || [];
                
                console.log(`Successfully loaded ${AppState.temples.length} temples and ${AppState.tourCircuits.length} circuits`);
                
                if (AppState.temples.length === 0) {
                    showError('No temple data available', $('nearby-temples-grid'));
                    return;
                }
                
                // Show success toast
                showToast(`Loaded ${AppState.temples.length} temples successfully!`, 'success');
                
                // Initial load of nearby temples
                loadNearbyTemples();
                loadTourCircuits();
                
            } catch (error) {
                console.error('Failed to load temple data:', error);
                const errorMessage = error.message.includes('fetch') ? 
                    'Unable to load temple database. If you are viewing this locally, please run a local server. If online, please refresh the page.' :
                    `Error loading temple data: ${error.message}. Please refresh the page or try again later.`;
                
                showError(errorMessage, $('nearby-temples-grid'));
                showError(errorMessage, $('tour-circuits-list'));
                showToast('Failed to load temple data', 'error');
            }
        }

        // Screen Management
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            $(screenId).classList.add('active');
            AppState.currentScreen = screenId;
            
            // Load content for specific screens
            if (screenId === 'festivals-screen') {
                loadFestivals();
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-screen="${screenId}"]`).classList.add('active');
            
            // Screen-specific initialization
            if (screenId === 'discovery-screen') {
                loadDiscoveryTemples();
            } else if (screenId === 'tours-screen') {
                loadTourCircuits();
            }
        }

        // Temple Rendering
        function createTempleCard(temple, showDistance = true) {
            const distance = AppState.currentLocation ? 
                calculateDistance(
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng,
                    temple.latitude,
                    temple.longitude
                ) : null;

            const hasLocation = temple.latitude && temple.longitude;
            const navigationText = getLocalizedString('buttons.navigation', AppState.currentLanguage);
            const noLocationText = getLocalizedString('temple_details.no_location', AppState.currentLanguage);
            const locationIndicator = hasLocation ? 
                `<span class="location-indicator location-available"><i class="fas fa-navigation"></i> ${navigationText}</span>` :
                `<span class="location-indicator location-unavailable"><i class="fas fa-times-circle"></i> ${noLocationText}</span>`;

            // Determine current display name based on language setting
            const displayName = AppState.currentLanguage === 'ta' && temple.tamil_name ? temple.tamil_name : temple.name;
            const nameClass = AppState.currentLanguage === 'ta' ? 'tamil' : '';
            
            // Get crowd level if available
            let crowdInfo = '';
            if (temple.popular_times && temple.popular_times.length > 0) {
                const now = new Date();
                const hour = now.getHours();
                const currentTimeEntry = temple.popular_times.find(entry => {
                    const entryHour = parseHourFromPopularTime(entry);
                    return entryHour === hour;
                });
                
                if (currentTimeEntry) {
                    const percentage = parseInt(currentTimeEntry.match(/\d+/)[0]);
                    const crowdLevelKey = percentage >= 40 ? 'high' : percentage >= 20 ? 'medium' : 'low';
                    const crowdLevel = getLocalizedString(`temple_details.${crowdLevelKey}`, AppState.currentLanguage);
                    const crowdColor = percentage >= 40 ? 'var(--error-red)' : percentage >= 20 ? 'var(--warning-orange)' : 'var(--success-green)';
                    crowdInfo = `<span style="color: ${crowdColor}; font-size: 0.75rem;"><i class="fas fa-users"></i> ${crowdLevel}</span>`;
                }
            }

            return `
                <div class="temple-card" onclick="showTempleDetail('${temple.id}')">
                    <div class="temple-header">
                        <div class="temple-name ${nameClass}">${displayName}</div>
                        <div class="temple-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${getLocalizedDistrict(temple.district)}
                        </div>
                        ${temple.gm_address && temple.gm_address !== temple.district ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; line-height: 1.3;">${temple.gm_address.length > 50 ? temple.gm_address.substring(0, 50) + '...' : temple.gm_address}</div>` : ''}
                    </div>
                    <div class="temple-info">
                        <div class="distance">
                            ${distance && showDistance ? formatDistance(distance) : ''}
                        </div>
                    </div>
                    <div class="temple-actions" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; justify-content: space-between;">
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            ${locationIndicator}
                            <span style="color: var(--text-secondary); text-transform: capitalize; font-size: 0.85rem;">${getLocalizedDeity(temple.deity_type)}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            ${temple.gm_phone ? `<span style="color: var(--success-green); font-size: 0.75rem;"><i class="fas fa-phone"></i></span>` : ''}
                            ${crowdInfo}
                        </div>
                    </div>
                </div>
            `;
        }

        function loadNearbyTemples() {
            const container = $('nearby-temples-grid');
            
            if (AppState.temples.length === 0) {
                showLoading(container, getLocalizedString('loading.finding_nearby'));
                return;
            }

            // Sort temples by distance if location is available
            let nearbyTemples = [...AppState.temples];
            
            if (AppState.currentLocation) {
                nearbyTemples = nearbyTemples
                    .map(temple => ({
                        ...temple,
                        distance: temple.latitude && temple.longitude ? 
                            calculateDistance(
                                AppState.currentLocation.lat,
                                AppState.currentLocation.lng,
                                temple.latitude,
                                temple.longitude
                            ) : Infinity
                    }))
                    .sort((a, b) => a.distance - b.distance);
            }

            // Show first 6 temples
            const templeHTML = nearbyTemples
                .slice(0, 6)
                .map(temple => createTempleCard(temple))
                .join('');

            container.innerHTML = templeHTML;
        }

        function loadDiscoveryTemples() {
            const container = $('discovery-temples-grid');
            const activeFilterBtn = document.querySelector('.filter-btn.active');
            
            if (!activeFilterBtn) {
                showError('Filter selection error', container);
                return;
            }
            
            const activeFilter = activeFilterBtn.dataset.filter;
            
            let filteredTemples = [...AppState.temples];
            
            // Apply filters
            if (activeFilter !== 'all') {
                if (activeFilter === 'location') {
                    filteredTemples = filteredTemples.filter(temple => 
                        temple.latitude && temple.longitude
                    );
                } else {
                    filteredTemples = filteredTemples.filter(temple => 
                        temple.deity_type === activeFilter
                    );
                }
            }

            // Sort by distance if location available
            if (AppState.currentLocation) {
                filteredTemples = filteredTemples
                    .map(temple => ({
                        ...temple,
                        distance: temple.latitude && temple.longitude ? 
                            calculateDistance(
                                AppState.currentLocation.lat,
                                AppState.currentLocation.lng,
                                temple.latitude,
                                temple.longitude
                            ) : Infinity
                    }))
                    .sort((a, b) => a.distance - b.distance);
            }

            const templeHTML = filteredTemples
                .slice(0, 50) // Limit to 50 temples for performance
                .map(temple => createTempleCard(temple))
                .join('');

            container.innerHTML = templeHTML || '<div class="text-center" style="padding: 3rem;">No temples found matching your criteria.</div>';
        }

        // Temple Detail View
        function showTempleDetail(templeId) {
            const temple = AppState.temples.find(t => t.id === templeId);
            if (!temple) return;

            AppState.currentTemple = temple;

            // Update temple details
            $('temple-detail-name').textContent = temple.name;
            $('temple-detail-location').textContent = getLocalizedDistrict(temple.district);
            // Rating removed as per user request
            $('temple-deity').textContent = getLocalizedDeity(temple.deity_type);
            
            // Update labels with localized text
            $('deity-label').textContent = getLocalizedString('temple_details.deity', AppState.currentLanguage) || 'Deity';
            $('distance-label').textContent = getLocalizedString('temple_details.distance', AppState.currentLanguage) || 'Distance';
            $('temple-info-header').textContent = getLocalizedString('temple_details.temple_information', AppState.currentLanguage) || 'Temple Information';
            
            // Update Popular Times header if visible
            const popularTimesHeader = $('popular-times-header');
            if (popularTimesHeader) {
                popularTimesHeader.textContent = getLocalizedString('temple_details.popular_times', AppState.currentLanguage) || 'Popular Times';
            }

            // Calculate and show distance
            if (AppState.currentLocation && temple.latitude && temple.longitude) {
                const distance = calculateDistance(
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng,
                    temple.latitude,
                    temple.longitude
                );
                $('temple-distance').textContent = formatDistance(distance);
            } else {
                $('temple-distance').textContent = 'N/A';
            }

            // Update address and contact info
            let addressHTML = `<p><i class="fas fa-map-marker-alt"></i> ${temple.gm_address || getLocalizedDistrict(temple.district)}</p>`;
            if (temple.gm_phone) {
                addressHTML += `<p style="margin-top: 0.5rem;"><i class="fas fa-phone" style="color: var(--success-green);"></i> <a href="tel:${temple.gm_phone}" style="color: var(--success-green); text-decoration: none;">${temple.gm_phone}</a></p>`;
            }
            $('temple-address').innerHTML = addressHTML;

            // Update location status
            const hasLocation = temple.latitude && temple.longitude;
            const locationAvailableText = getLocalizedString('temple_details.location_available', AppState.currentLanguage);
            const noLocationAvailableText = getLocalizedString('temple_details.no_location_available', AppState.currentLanguage);
            $('temple-location-status').innerHTML = hasLocation ?
                `<div class="location-indicator location-available"><i class="fas fa-map-marker-alt"></i> ${locationAvailableText}</div>` :
                `<div class="location-indicator location-unavailable"><i class="fas fa-times-circle"></i> ${noLocationAvailableText}</div>`;
            
            // Show/hide action buttons based on data availability
            const navigateBtn = $('navigate-btn');
            const callBtn = $('call-btn');
            const actionsContainer = document.querySelector('.temple-actions-detail');
            
            // Show/hide navigation button
            if (hasLocation) {
                navigateBtn.style.display = 'flex';
            } else {
                navigateBtn.style.display = 'none';
            }
            
            // Update button texts with localized strings
            const navigateBtnText = $('navigate-btn-text');
            if (navigateBtnText) {
                navigateBtnText.textContent = getLocalizedString('buttons.navigate');
            }
            
            const callBtnText = $('call-btn-text');
            if (callBtnText) {
                callBtnText.textContent = getLocalizedString('buttons.call_temple');
            }
            
            // Show/hide call button
            if (temple.gm_phone) {
                callBtn.style.display = 'flex';
                callBtn.style.opacity = '1';
                callBtn.style.cursor = 'pointer';
            } else {
                callBtn.style.display = 'flex';
                callBtn.style.opacity = '0.5';
                callBtn.style.cursor = 'not-allowed';
            }
            
            // Adjust grid based on visible buttons
            const buttonsVisible = (hasLocation ? 1 : 0) + (temple.gm_phone ? 1 : 0);
            if (actionsContainer) {
                if (buttonsVisible === 2) {
                    actionsContainer.style.gridTemplateColumns = '1fr 1fr';
                } else if (buttonsVisible === 1) {
                    actionsContainer.style.gridTemplateColumns = '1fr';
                } else {
                    actionsContainer.style.display = 'none';
                }
            }

            // Show Tamil name if available
            if (temple.tamil_name && temple.tamil_name !== temple.name + ' கோவில்') {
                $('temple-tamil-name').textContent = temple.tamil_name;
                $('tamil-name-section').style.display = 'block';
            } else {
                $('tamil-name-section').style.display = 'none';
            }

            // Update website if available
            if (temple.gm_website) {
                $('temple-website').innerHTML = `<p style="margin-top: 0.5rem;"><i class="fas fa-globe" style="color: var(--primary-saffron);"></i> <a href="${temple.gm_website}" target="_blank" style="color: var(--primary-saffron); text-decoration: none;">Visit Website</a></p>`;
            } else {
                $('temple-website').innerHTML = '';
            }

            // Enhanced crowd info with popular times analysis
            if (temple.popular_times && temple.popular_times.length > 0) {
                const now = new Date();
                const hour = now.getHours();
                
                // Parse popular times to get actual crowd percentages
                let currentCrowdLevel = 'Low';
                let currentPercentage = 0;
                let crowdClass = 'crowd-low';
                
                // Find crowd level for current hour
                const currentTimeEntry = temple.popular_times.find(entry => {
                    const entryHour = parseHourFromPopularTime(entry);
                    return entryHour === hour;
                });
                
                if (currentTimeEntry) {
                    currentPercentage = parseInt(currentTimeEntry.match(/\d+/)[0]);
                    if (currentPercentage >= 40) {
                        currentCrowdLevel = 'High';
                        crowdClass = 'crowd-high';
                    } else if (currentPercentage >= 20) {
                        currentCrowdLevel = 'Medium';
                        crowdClass = 'crowd-medium';
                    }
                }

                // Only show current crowd level in Temple Information section
                const currentCrowdText = getLocalizedString('temple_details.current_crowd_level', AppState.currentLanguage) || 'Current crowd level:';
                const lowText = getLocalizedString('temple_details.low', AppState.currentLanguage) || 'Low';
                const mediumText = getLocalizedString('temple_details.medium', AppState.currentLanguage) || 'Medium';
                const highText = getLocalizedString('temple_details.high', AppState.currentLanguage) || 'High';
                
                let localizedCrowdLevel = currentCrowdLevel;
                if (currentCrowdLevel === 'Low') localizedCrowdLevel = lowText;
                else if (currentCrowdLevel === 'Medium') localizedCrowdLevel = mediumText;
                else if (currentCrowdLevel === 'High') localizedCrowdLevel = highText;
                
                let crowdHTML = `
                    <div class="crowd-indicator ${crowdClass}" style="margin-top: 0.5rem;">
                        <i class="fas fa-users"></i>
                        <span>${currentCrowdText} ${localizedCrowdLevel}</span>
                        ${currentPercentage > 0 ? `<span style="margin-left: 0.5rem; opacity: 0.8;">(${currentPercentage}%)</span>` : ''}
                    </div>
                `;

                $('temple-crowd-info').innerHTML = crowdHTML;
                
                // Also show the popular times chart in its dedicated section
                $('temple-popular-times').innerHTML = `
                    <div style="margin-top: 0.5rem;">
                        <div style="display: flex; align-items: flex-end; gap: 4px; padding-bottom: 25px; position: relative;">
                            ${Array.from({length: 15}, (_, idx) => {
                                const i = idx + 6;
                                const timeEntry = temple.popular_times.find(entry => parseHourFromPopularTime(entry) === i);
                                const percentage = timeEntry ? parseInt(timeEntry.match(/\d+/)[0]) : 0;
                                const height = Math.max(percentage * 0.8, 8);
                                const isCurrentHour = i === hour;
                                const showLabel = i === 6 || i === 9 || i === 12 || i === 15 || i === 18 || i === 20;
                                
                                return `
                                    <div style="
                                        flex: 1;
                                        height: ${height}px; 
                                        background: ${isCurrentHour ? 'var(--primary-saffron)' : percentage >= 40 ? 'var(--error-red)' : percentage >= 20 ? 'var(--warning-orange)' : 'var(--success-green)'}; 
                                        border-radius: 4px 4px 0 0;
                                        position: relative;
                                        min-width: 16px;
                                        ${isCurrentHour ? 'box-shadow: 0 0 8px rgba(255, 107, 53, 0.6);' : ''}
                                        transition: all 0.2s ease;
                                    " title="${i}:00 - ${percentage}% busy">
                                        ${showLabel ? `<div style="position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--text-secondary); white-space: nowrap;">${i}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success-green); border-radius: 2px; margin-right: 4px;"></span>${getLocalizedString('temple_details.low', AppState.currentLanguage) || 'Low'}</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning-orange); border-radius: 2px; margin-right: 4px;"></span>${getLocalizedString('temple_details.medium', AppState.currentLanguage) || 'Medium'}</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--error-red); border-radius: 2px; margin-right: 4px;"></span>${getLocalizedString('temple_details.high', AppState.currentLanguage) || 'High'}</span>
                        </div>
                    </div>
                `;
                $('popular-times-section').style.display = 'block';
            } else {
                $('temple-crowd-info').innerHTML = '';
                $('temple-popular-times').innerHTML = '';
                $('popular-times-section').style.display = 'none';
            }

            // Update timings info (general temple hours)
            const typicalHours = getLocalizedString('temple_details.typical_hours', AppState.currentLanguage) || 'Typical Hours: 6:00 AM - 12:00 PM, 4:00 PM - 9:00 PM';
            const hoursMayVary = getLocalizedString('temple_details.hours_may_vary', AppState.currentLanguage) || '*Hours may vary. Please call temple for exact timings.';
            $('temple-timings').innerHTML = `
                <p style="margin-top: 0.5rem;"><i class="fas fa-clock" style="color: var(--warning-orange);"></i> <span style="color: var(--text-secondary);">${typicalHours}</span></p>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 1.2rem;">${hoursMayVary}</p>
            `;

            showScreen('temple-detail-screen');
        }

        // Helper function to parse hour from popular times string
        function parseHourFromPopularTime(timeString) {
            const timeMatch = timeString.match(/(\d+)\s*(am|pm)/);
            if (!timeMatch) return -1;
            
            let hour = parseInt(timeMatch[1]);
            const period = timeMatch[2];
            
            if (period === 'pm' && hour !== 12) hour += 12;
            if (period === 'am' && hour === 12) hour = 0;
            
            return hour;
        }

        // Navigation Functions
        function navigateToTemple() {
            const temple = AppState.currentTemple;
            if (!temple || !temple.latitude || !temple.longitude) {
                alert('Location not available for this temple');
                return;
            }

            const url = `https://www.google.com/maps/dir/?api=1&destination=${temple.latitude},${temple.longitude}&travelmode=driving`;
            window.open(url, '_blank');
        }

        function callTemple() {
            const temple = AppState.currentTemple;
            if (!temple || !temple.gm_phone) {
                alert('Contact information not available for this temple yet. Please check back later.');
                return;
            }

            window.location.href = `tel:${temple.gm_phone}`;
        }

        // Tour Circuit Functions
        function loadTourCircuits() {
            const container = $('tour-circuits-list');
            
            if (AppState.tourCircuits.length === 0) {
                showLoading(container, getLocalizedString('loading.tour_circuits'));
                return;
            }

            const circuitHTML = AppState.tourCircuits.map(circuit => {
                // Display name based on current language
                const displayName = AppState.currentLanguage === 'ta' && circuit.tamil_name ? circuit.tamil_name : circuit.name;
                const nameClass = AppState.currentLanguage === 'ta' ? 'tamil' : '';
                const templesText = AppState.currentLanguage === 'ta' ? 'கோயில்கள்' : 'Temples';
                
                return `
                    <div class="circuit-card" onclick="showTourDetail('${circuit.id}')">
                        <div class="circuit-header">
                            <div>
                                <div class="circuit-title ${nameClass}">${displayName}</div>
                            </div>
                        </div>
                        <p style="margin: 1rem 0; opacity: 0.9;">${circuit.description}</p>
                        <div class="circuit-meta">
                            <span><i class="fas fa-map-marked-alt"></i> ${circuit.total_temples} ${templesText}</span>
                            <span><i class="fas fa-route"></i> ${formatDistance(circuit.total_distance_km)}</span>
                            <span><i class="fas fa-clock"></i> ${circuit.estimated_hours}h</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = circuitHTML;
        }

        // Festival data for Tamil Nadu temples - Complete 88 festivals
        function loadFestivals(filterType = 'all') {
            // Complete festival data with all 88 festivals including monthly observances
            if (allFestivals.length === 0) {
                allFestivals = [
    { date: '2025-01-09', name: 'Pausha Putrada Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-01-11', name: 'Shani Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-01-13', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-01-14', name: 'Pongal', tamil_name: 'பொங்கல்', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-01-15', name: 'Thiruvalluvar Day', tamil_name: 'திருவள்ளுவர் தினம்', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-01-24', name: 'Shattila Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-01-26', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-01-29', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-02-08', name: 'Jaya Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Thai' },
    { date: '2025-02-10', name: 'Soma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-02-12', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-02-22', name: 'Vijaya Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-02-24', name: 'Soma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-02-26', name: 'Maha Shivaratri', tamil_name: 'மகா சிவராத்திரி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-02-27', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-03-09', name: 'Amalaki Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Masi' },
    { date: '2025-03-11', name: 'Bhauma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-03-13', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-03-14', name: 'Holi', tamil_name: 'ஹோலி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-03-24', name: 'Papmochani Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-03-26', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-03-29', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-03-30', name: 'Ugadi/Gudi Padwa', tamil_name: 'உகாதி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-04-06', name: 'Ram Navami', tamil_name: 'ராம நவமி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-04-08', name: 'Kamada Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Panguni' },
    { date: '2025-04-10', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-04-12', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-04-14', name: 'Tamil New Year', tamil_name: 'தமிழ் புத்தாண்டு', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-04-14', name: 'Dr. Ambedkar Jayanti', tamil_name: 'அம்பேத்கர் ஜயந்தி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-04-22', name: 'Varuthini Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-04-24', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-04-27', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-05-07', name: 'Mohini Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Chithirai' },
    { date: '2025-05-09', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-05-12', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-05-22', name: 'Apara Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-05-24', name: 'Shani Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-05-26', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-06-06', name: 'Nirjala Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Vaikasi' },
    { date: '2025-06-08', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-06-11', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-06-20', name: 'Yogini Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-06-22', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-06-25', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-07-05', name: 'Devshayani Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aani' },
    { date: '2025-07-07', name: 'Soma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-07-10', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-07-20', name: 'Kamika Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-07-22', name: 'Bhauma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-07-24', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-08-04', name: 'Shravana Putrada Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aadi' },
    { date: '2025-08-06', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-08-09', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-08-16', name: 'Krishna Jayanthi', tamil_name: 'கிருஷ்ண ஜயந்தி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-08-18', name: 'Aja Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-08-20', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-08-23', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-08-27', name: 'Vinayagar Chaturthi', tamil_name: 'விநாயகர் சதுர்த்தி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-09-02', name: 'Parivartini Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aavani' },
    { date: '2025-09-04', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-09-07', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-09-17', name: 'Indira Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-09-19', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-09-21', name: 'Navaratri Begins', tamil_name: 'நவராத்திரி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-09-21', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-09-30', name: 'Vijayadashami', tamil_name: 'விஜயதசமி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-10-02', name: 'Papankusha Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Purattasi' },
    { date: '2025-10-04', name: 'Shani Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-10-07', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-10-16', name: 'Rama Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-10-18', name: 'Shani Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-10-20', name: 'Deepavali', tamil_name: 'தீபாவளி', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-10-21', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-11-01', name: 'Devutthana Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Aippasi' },
    { date: '2025-11-03', name: 'Soma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-11-05', name: 'Karthigai Deepam', tamil_name: 'கார்த்திகை தீபம்', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-11-05', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-11-15', name: 'Utpanna Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-11-17', name: 'Soma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-11-20', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-11-30', name: 'Mokshada Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Karthigai' },
    { date: '2025-12-02', name: 'Bhauma Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-12-04', name: 'Pournami (Full Moon)', tamil_name: 'பௌர்ணமி', temples: 'All temples - Full moon worship', type: 'pournami', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-12-15', name: 'Saphala Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-12-17', name: 'Pradosham', tamil_name: 'பிரதோஷம்', temples: 'All Shiva temples - Evening prayers', type: 'pradosham', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-12-19', name: 'Amavasya (New Moon)', tamil_name: 'அமாவாசை', temples: 'Ancestor worship at temples', type: 'amavasya', category: 'monthly', tamil_month: 'Margazhi' },
    { date: '2025-12-25', name: 'Christmas', tamil_name: 'கிறிஸ்துமஸ்', temples: 'All major temples', type: 'major', category: 'annual' },
    { date: '2025-12-30', name: 'Vaikunta Ekadashi', tamil_name: 'ஏகாதசி', temples: 'All Vishnu temples - Fasting day', type: 'ekadashi', category: 'monthly', tamil_month: 'Margazhi' }
];
                // Update festival filter button counts after loading data
                updateFestivalFilterCounts(AppState.currentLanguage);
            }
            
            // Filter festivals based on type
            let festivals = allFestivals;
            if (filterType !== 'all') {
                festivals = allFestivals.filter(f => f.type === filterType);
            }
            
            // Get current date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filter and sort upcoming festivals
            const upcomingFestivals = festivals
                .filter(f => new Date(f.date) >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 10); // Show next 10 festivals
            
            // Update festival count with localized text
            let countText;
            if (filterType === 'all') {
                countText = AppState.currentLanguage === 'ta' ? 
                    `அனைத்து ${upcomingFestivals.length} வரவிருக்கும் திருவிழாக்களும் காட்டப்படுகின்றன` :
                    `Showing all ${upcomingFestivals.length} upcoming festivals`;
            } else {
                // Get localized filter type name
                const filterTypeNames = {
                    'ta': {
                        'major': 'முக்கிய திருவிழாக்கள்',
                        'pradosham': 'பிரதோஷம்',
                        'ekadashi': 'ஏகாதசி',
                        'pournami': 'பௌர்ணமி',
                        'amavasya': 'அமாவாசை'
                    },
                    'en': {
                        'major': 'major festivals',
                        'pradosham': 'Pradosham',
                        'ekadashi': 'Ekadashi',
                        'pournami': 'Full Moon',
                        'amavasya': 'New Moon'
                    }
                };
                
                const typeName = filterTypeNames[AppState.currentLanguage][filterType] || filterType;
                countText = AppState.currentLanguage === 'ta' ? 
                    `${upcomingFestivals.length} வரவிருக்கும் ${typeName} அனுஷ்டானங்கள் காட்டப்படுகின்றன` :
                    `Showing ${upcomingFestivals.length} upcoming ${typeName} observances`;
            }
            const countElement = $('festival-count');
            if (countElement) countElement.textContent = countText;
            
            // Generate festival cards
            const container = $('festivals-list');
            let festivalHTML = '';
            
            upcomingFestivals.forEach(festival => {
                const festivalDate = new Date(festival.date);
                const daysUntil = Math.ceil((festivalDate - today) / (1000 * 60 * 60 * 24));
                
                // Create smart date display
                let dateDisplay = '';
                if (daysUntil === 0) {
                    dateDisplay = 'Today';
                } else if (daysUntil === 1) {
                    dateDisplay = 'Tomorrow';
                } else if (daysUntil <= 7) {
                    dateDisplay = `In ${daysUntil} days - ${festivalDate.toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' })}`;
                } else if (daysUntil <= 30) {
                    dateDisplay = `In ${Math.floor(daysUntil / 7)} weeks - ${festivalDate.toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' })}`;
                } else {
                    dateDisplay = festivalDate.toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' });
                }
                
                const displayName = AppState.currentLanguage === 'ta' ? festival.tamil_name : festival.name;
                
                // Translate temple descriptions
                const templeDescriptions = {
                    'ta': {
                        'All Vishnu temples - Fasting day': 'அனைத்து விஷ்ணு கோயில்கள் - நோன்பு நாள்',
                        'All Shiva temples - Evening prayers': 'அனைத்து சிவன் கோயில்கள் - மாலை பூஜை',
                        'All temples - Full moon worship': 'அனைத்து கோயில்கள் - பௌர்ணமி வழிபாடு',
                        'Ancestor worship at temples': 'கோயில்களில் முன்னோர் வழிபாடு',
                        'All major temples': 'அனைத்து முக்கிய கோயில்கள்'
                    }
                };
                
                let templeDescription = festival.temples;
                if (AppState.currentLanguage === 'ta' && templeDescriptions.ta[festival.temples]) {
                    templeDescription = templeDescriptions.ta[festival.temples];
                }
                
                // Add localized badge for different types
                let badge = '';
                const badgeLabels = {
                    'ta': {
                        'major': 'முக்கிய திருவிழா',
                        'pradosham': 'பிரதோஷம்',
                        'ekadashi': 'ஏகாதசி',
                        'pournami': 'பௌர்ணமி',
                        'amavasya': 'அமாவாசை'
                    },
                    'en': {
                        'major': 'Major Festival',
                        'pradosham': 'Pradosham',
                        'ekadashi': 'Ekadashi',
                        'pournami': 'Full Moon',
                        'amavasya': 'New Moon'
                    }
                };
                
                const badgeText = badgeLabels[AppState.currentLanguage][festival.type];
                
                if (festival.type === 'major') {
                    badge = `<span class="badge" style="background: var(--primary-saffron); color: white;">${badgeText}</span>`;
                } else if (festival.type === 'pradosham') {
                    badge = `<span class="badge" style="background: #9C27B0; color: white;">${badgeText}</span>`;
                } else if (festival.type === 'ekadashi') {
                    badge = `<span class="badge" style="background: #2196F3; color: white;">${badgeText}</span>`;
                } else if (festival.type === 'pournami') {
                    badge = `<span class="badge" style="background: #FFC107; color: #333;">${badgeText}</span>`;
                } else if (festival.type === 'amavasya') {
                    badge = `<span class="badge" style="background: #607D8B; color: white;">${badgeText}</span>`;
                }
                
                festivalHTML += `
                    <div class="festival-card ${festival.type === 'major' ? 'major-festival' : ''}">
                        <div class="festival-date">${dateDisplay}</div>
                        <div class="festival-name ${AppState.currentLanguage === 'ta' ? 'tamil' : ''}">${displayName}</div>
                        <div class="festival-temples">${templeDescription}</div>
                        ${badge ? `<div style="margin-top: 0.5rem;">${badge}</div>` : ''}
                        ${festival.tamil_month ? `<small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">${AppState.currentLanguage === 'ta' ? 'தமிழ் மாதம்: ' + getTamilMonthName(festival.tamil_month) : 'Tamil Month: ' + festival.tamil_month}</small>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = festivalHTML || '<p style="text-align: center; color: var(--text-secondary);">No upcoming festivals found</p>';
        }

        function showTourDetail(circuitId) {
            const circuit = AppState.tourCircuits.find(c => c.id === circuitId);
            if (!circuit) return;

            AppState.currentCircuit = circuit;

            // Update circuit details
            const displayName = AppState.currentLanguage === 'ta' && circuit.tamil_name ? circuit.tamil_name : circuit.name;
            $('circuit-name').textContent = displayName;
            $('circuit-description').textContent = circuit.description;
            $('circuit-temples-count').textContent = circuit.total_temples;
            $('circuit-distance').textContent = circuit.total_distance_km;
            $('circuit-duration').textContent = circuit.estimated_hours;

            // Load related temples based on circuit type
            const circuitTemplesContainer = $('circuit-temples-container');
            let relevantTemples = [];
            
            // Find temples that match the circuit type
            if (circuit.circuit_type === 'navagraha') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.name.toLowerCase().includes('navagraha') ||
                    temple.name.toLowerCase().includes('surya') ||
                    temple.name.toLowerCase().includes('chandra') ||
                    temple.name.toLowerCase().includes('angaraka') ||
                    temple.name.toLowerCase().includes('budha') ||
                    temple.name.toLowerCase().includes('guru') ||
                    temple.name.toLowerCase().includes('shukra') ||
                    temple.name.toLowerCase().includes('shani') ||
                    temple.name.toLowerCase().includes('rahu') ||
                    temple.name.toLowerCase().includes('ketu')
                ).slice(0, 9);
            } else if (circuit.circuit_type === 'murugan') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.deity_type === 'murugan' || 
                    temple.name.toLowerCase().includes('murugan') ||
                    temple.name.toLowerCase().includes('kartikeya') ||
                    temple.name.toLowerCase().includes('subrahmanya')
                ).slice(0, 6);
            } else if (circuit.circuit_type === 'shiva') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.deity_type === 'shiva'
                ).slice(0, circuit.total_temples || 10);
            } else {
                // For other circuits, show highly rated temples of various types
                relevantTemples = AppState.temples
                    .filter(temple => temple.gm_rating && temple.gm_rating >= 4.0)
                    .sort((a, b) => (b.gm_rating || 0) - (a.gm_rating || 0))
                    .slice(0, circuit.total_temples || 8);
            }

            // Store temples in circuit for navigation
            circuit.temples = relevantTemples;
            
            if (relevantTemples.length > 0) {
                let templesHTML = '';
                relevantTemples.forEach((temple, index) => {
                    const displayName = AppState.currentLanguage === 'ta' && temple.tamil_name ? temple.tamil_name : temple.name;
                    const hasLocation = temple.latitude && temple.longitude;
                    
                    templesHTML += `
                        <div class="circuit-temple-item" onclick="showTempleDetail('${temple.id}')">
                            <div class="temple-number">${index + 1}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${AppState.currentLanguage === 'ta' ? 'font-family: \"Noto Sans Tamil\", sans-serif;' : ''}">${displayName}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; display: flex; align-items: center; gap: 1rem;">
                                    <span><i class="fas fa-map-marker-alt"></i> ${getLocalizedDistrict(temple.district)}</span>
                                    ${temple.gm_rating ? `<span><i class="fas fa-star" style="color: var(--secondary-gold);"></i> ${temple.gm_rating}</span>` : ''}
                                    ${temple.deity_type ? `<span style="text-transform: capitalize;">${temple.deity_type}</span>` : ''}
                                </div>
                                <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; align-items: center;">
                                    ${hasLocation ? '<span class="location-indicator location-available" style="font-size: 0.7rem; padding: 0.125rem 0.25rem;"><i class="fas fa-map-marker-alt"></i> Location</span>' : '<span class="location-indicator location-unavailable" style="font-size: 0.7rem; padding: 0.125rem 0.25rem;"><i class="fas fa-times-circle"></i> No Location</span>'}
                                    ${temple.gm_phone ? '<span style="color: var(--success-green); font-size: 0.7rem;"><i class="fas fa-phone"></i> Call</span>' : ''}
                                </div>
                            </div>
                            <div style="color: var(--primary-saffron);">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    `;
                });
                circuitTemplesContainer.innerHTML = templesHTML;
            } else {
                circuitTemplesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No temples found for this circuit type.</p>
                        <p style="font-size: 0.9rem;">This circuit is still being developed.</p>
                    </div>
                `;
            }

            showScreen('tour-detail-screen');
        }

        function startCircuit() {
            const circuit = AppState.currentCircuit;
            if (!circuit || !circuit.temples || circuit.temples.length === 0) {
                alert('No temples available in this circuit');
                return;
            }

            // Get temples with GPS coordinates
            const navigableTemples = circuit.temples.filter(t => t.latitude && t.longitude);
            
            if (navigableTemples.length === 0) {
                alert('Sorry, navigation is not available for temples in this circuit yet. Location data coming soon!');
                return;
            }

            // Create Google Maps directions URL with multiple waypoints
            let mapsUrl = 'https://www.google.com/maps/dir/';
            
            // Add current location as starting point
            if (AppState.userLocation) {
                mapsUrl += `${AppState.userLocation.lat},${AppState.userLocation.lng}/`;
            }
            
            // Add all temple waypoints
            navigableTemples.forEach(temple => {
                mapsUrl += `${temple.latitude},${temple.longitude}/`;
            });
            
            // Open Google Maps with the circuit route
            window.open(mapsUrl, '_blank');
            
            // Show confirmation
            showToast(`Opening ${circuit.name} route in Google Maps`, 'success');
        }

        // Search Functionality
        function initializeSearch() {
            const searchInput = $('main-search');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value);
                }, 300);
            });
        }

        function performSearch(query) {
            if (!query || query.length < 2) {
                if (AppState.currentScreen === 'home-screen') {
                    // Show normal home screen content
                    document.querySelector('.quick-actions').style.display = 'grid';
                    document.querySelector('.hero').style.display = 'block';
                    document.querySelector('.nearest-temples .section-header').style.display = 'flex';
                    document.querySelector('#nearby-section-title').textContent = getLocalizedString('nearest_temples');
                    loadNearbyTemples();
                }
                return;
            }

            // Enhanced bilingual search with Tamil deity matching
            const enhancedTemples = enhanceTempleSearchForTamil(AppState.temples);
            
            const searchResults = enhancedTemples.filter(temple => {
                const queryLower = query.toLowerCase().trim();
                
                // Direct substring matching in English
                const englishMatch = (
                    temple.name.toLowerCase().includes(queryLower) ||
                    temple.district.toLowerCase().includes(queryLower) ||
                    (temple.deity_type && temple.deity_type.toLowerCase().includes(queryLower))
                );
                
                if (englishMatch) return true;
                
                // Tamil keyword matching for deity names
                const tamilKeywordMatch = temple.tamil_search_keywords && 
                    temple.tamil_search_keywords.includes(query.trim());
                    
                if (tamilKeywordMatch) return true;
                
                // Basic Tamil name matching (current format)
                const tamilNameMatch = temple.tamil_name && 
                    temple.tamil_name.toLowerCase().includes(queryLower);
                    
                if (tamilNameMatch) return true;
                
                // Word-based matching for partial searches
                const queryWords = queryLower.split(/\s+/);
                const nameWords = temple.name.toLowerCase().split(/\s+/);
                
                const wordMatch = queryWords.some(queryWord => 
                    nameWords.some(nameWord => 
                        nameWord.includes(queryWord) || queryWord.includes(nameWord)
                    )
                );
                
                return wordMatch;
            });

            // Show results in current context
            if (AppState.currentScreen === 'home-screen') {
                // Hide quick actions and hero to make room for search results
                document.querySelector('.quick-actions').style.display = 'none';
                document.querySelector('.hero').style.display = 'none';
                
                // Update section title to show search status  
                const resultsText = AppState.currentLanguage === 'ta' ? 
                    `தேடல் முடிவுகள் (${searchResults.length})` : 
                    `Search Results (${searchResults.length})`;
                document.querySelector('#nearby-section-title').textContent = resultsText;
                
                const container = $('nearby-temples-grid');
                if (searchResults.length > 0) {
                    const resultsHTML = searchResults
                        .map(temple => createTempleCard(temple))
                        .join('');
                    container.innerHTML = resultsHTML;
                    
                    // Auto-scroll to results on mobile
                    if (window.innerWidth <= 768) {
                        document.querySelector('.nearest-temples').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                } else {
                    const noResultsText = getLocalizedString('errors.no_temples_found');
                    container.innerHTML = `<div class="text-center" style="padding: 3rem;">${noResultsText}</div>`;
                }
            } else if (AppState.currentScreen === 'discovery-screen') {
                loadDiscoveryTemples();
            }
        }

        // Map Functionality
        function initializeMap() {
            if (!AppState.map) {
                AppState.map = L.map('temple-map').setView([
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng
                ], 10);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(AppState.map);
            }

            // Clear existing markers
            AppState.map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    AppState.map.removeLayer(layer);
                }
            });

            // Add temple markers
            const templesToShow = AppState.temples.filter(temple => 
                temple.latitude && temple.longitude
            ).slice(0, 100); // Limit for performance

            templesToShow.forEach(temple => {
                L.marker([temple.latitude, temple.longitude])
                    .addTo(AppState.map)
                    .bindPopup(`
                        <strong>${temple.name}</strong><br>
                        ${temple.district}<br>
                        <em>${temple.deity_type || 'Temple'}</em><br>
                        <button onclick="showTempleDetail('${temple.id}')" class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">View Details</button>
                    `);
            });

            // Add user location marker if available
            if (AppState.userLocation) {
                L.marker([AppState.userLocation.lat, AppState.userLocation.lng])
                    .addTo(AppState.map)
                    .bindPopup('Your Location')
                    .openPopup();
            }
        }

        // Filter Functions
        function initializeFilters() {
            // Discovery temple filters
            const discoveryFilterBtns = document.querySelectorAll('#discovery-screen .filter-btn');
            discoveryFilterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active from all buttons
                    discoveryFilterBtns.forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    e.target.classList.add('active');
                    // Reload temples with new filter
                    loadDiscoveryTemples();
                });
            });
            
            // Festival type filters
            const festivalFilterBtns = document.querySelectorAll('#festivals-screen .filter-btn');
            festivalFilterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active from all buttons
                    festivalFilterBtns.forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    e.target.classList.add('active');
                    // Get filter type
                    const filterType = e.target.dataset.festivalType;
                    // Reload festivals with filter
                    loadFestivals(filterType);
                });
            });
        }

        // Settings Functions
        function initializeSettings() {
            const toggles = document.querySelectorAll('.toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    
                    // Handle language toggle specifically
                    if (toggle.id === 'language-setting') {
                        const newLang = toggle.classList.contains('active') ? 'ta' : 'en';
                        updateLanguage(newLang);
                    }
                });
            });
        }

        // Error Handling
        function showError(message, container = null) {
            console.error(message);
            
            const errorHTML = `
                <div style="
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid var(--error-red);
                    color: var(--error-red);
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                    margin: 1rem 0;
                ">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                    <span>${message}</span>
                    <button onclick="location.reload()" style="
                        background: var(--error-red);
                        color: white;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 4px;
                        margin-left: 1rem;
                        cursor: pointer;
                        font-size: 0.85rem;
                    ">Retry</button>
                </div>
            `;
            
            if (container) {
                container.innerHTML = errorHTML;
            } else {
                // Show error toast
                showToast(message, 'error');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 1rem;
                background: ${type === 'error' ? 'var(--error-red)' : type === 'success' ? 'var(--success-green)' : 'var(--primary-saffron)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: var(--shadow-hover);
                z-index: 1000;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check' : 'info-circle'}" style="margin-right: 0.5rem;"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 5000);
        }
        
        function showLoading(container, message = null) {
            const defaultMessage = getLocalizedMessage('loading') || 'Loading...';
            container.innerHTML = `
                <div class="loading" style="min-height: 200px;">
                    <div class="spinner"></div>
                    <span>${message || defaultMessage}</span>
                </div>
            `;
        }

        // Event Listeners
        function initializeEventListeners() {
            // Language toggle
            $('language-toggle').addEventListener('click', () => {
                const newLang = AppState.currentLanguage === 'en' ? 'ta' : 'en';
                updateLanguage(newLang);
            });

            // Location button removed - auto-fetching instead

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showScreen(item.dataset.screen);
                });
            });

            // Quick actions
            $('nearest-action').addEventListener('click', () => showScreen('discovery-screen'));
            $('map-action').addEventListener('click', () => {
                showScreen('discovery-screen');
                setTimeout(() => {
                    $('map-view-btn').click();
                }, 100);
            });
            $('tours-action').addEventListener('click', () => showScreen('tours-screen'));
            $('festivals-action').addEventListener('click', () => showScreen('festivals-screen'));

            // View toggles
            $('list-view-btn').addEventListener('click', () => {
                $('list-view-btn').classList.add('btn-primary');
                $('list-view-btn').classList.remove('btn-secondary');
                $('map-view-btn').classList.add('btn-secondary');
                $('map-view-btn').classList.remove('btn-primary');
                $('temple-map').style.display = 'none';
                $('discovery-temples-grid').style.display = 'grid';
            });

            $('map-view-btn').addEventListener('click', () => {
                $('map-view-btn').classList.add('btn-primary');
                $('map-view-btn').classList.remove('btn-secondary');
                $('list-view-btn').classList.add('btn-secondary');
                $('list-view-btn').classList.remove('btn-primary');
                $('temple-map').style.display = 'block';
                $('discovery-temples-grid').style.display = 'none';
                setTimeout(() => initializeMap(), 100);
            });

            // Temple actions
            $('navigate-btn').addEventListener('click', navigateToTemple);
            $('call-btn').addEventListener('click', callTemple);
            $('start-circuit-btn').addEventListener('click', startCircuit);

            // View all nearby
            $('view-all-nearby').addEventListener('click', () => showScreen('discovery-screen'));

            // Initialize search
            initializeSearch();
            initializeFilters();
            initializeSettings();
        }

        // App Initialization
        async function initializeApp() {
            console.log('Initializing Kovil Valikatti App...');
            
            try {
                // Load localization data first
                await loadLocalizationData();
                
                // Load saved preferences and apply language
                const savedLang = localStorage.getItem('preferred-language') || 'en';
                AppState.currentLanguage = savedLang;
                updateLanguage(savedLang);
                
                // Auto-fetch user location in background
                autoFetchLocation();
                
                // Initialize event listeners
                initializeEventListeners();
                
                // Load temple data
                await loadTempleData();
                
                // Request location permission
                requestLocation();
                
                console.log('✅ App initialization complete!');
                showToast('கோவில் வழிகாட்டி தயார்! / Kovil Valikatti Ready!', 'success');
            } catch (error) {
                console.error('❌ App initialization failed:', error);
                showToast('App initialization failed. Some features may not work properly.', 'error');
            }
        }

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Make functions globally available
        window.showTempleDetail = showTempleDetail;
        window.showTourDetail = showTourDetail;
    </script>
</body>
</html>