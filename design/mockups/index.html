<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamil Nadu Temple Calendar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-saffron: #FF6B35;
            --secondary-gold: #FFD700;
            --background-cream: #FFF8E7;
            --text-dark: #3E2723;
            --text-secondary: #6D4C41;
            --card-white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.15);
            --border-light: #E0E0E0;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --error-red: #F44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-cream);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .tamil {
            font-family: 'Noto Sans Tamil', sans-serif;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-saffron), #FF8A65);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo i {
            margin-right: 0.5rem;
            font-size: 1.4rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-saffron);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--primary-saffron);
            border: 2px solid var(--primary-saffron);
        }

        .btn-ghost {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Home Screen */
        .home-section {
            padding: 2rem 0;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .action-card {
            background: var(--card-white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-saffron);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--primary-saffron);
            margin-bottom: 1rem;
        }

        .action-card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Nearest Temples */
        .nearest-temples {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .temple-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .temple-card {
            background: var(--card-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .temple-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .temple-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .temple-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .temple-location {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .temple-info {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--secondary-gold);
        }

        .distance {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .temple-actions {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
        }

        /* Search Bar */
        .search-section {
            margin-bottom: 2rem;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--card-white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-saffron);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--card-white);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--primary-saffron);
            color: white;
            border-color: var(--primary-saffron);
        }

        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .map-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--primary-saffron);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tour Circuits */
        .circuit-card {
            background: linear-gradient(135deg, var(--primary-saffron), var(--secondary-gold));
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .circuit-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .circuit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .circuit-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .circuit-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-white);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            text-decoration: none;
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--primary-saffron);
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .nav-item span {
            font-size: 0.7rem;
        }

        /* Screen Containers */
        .screen {
            display: none;
            min-height: calc(100vh - 140px);
            padding-bottom: 80px;
        }

        .screen.active {
            display: block;
        }

        /* Temple Detail Screen */
        .temple-detail {
            max-width: 800px;
            margin: 0 auto;
        }

        .temple-detail-header {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .temple-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .temple-detail-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .temple-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .meta-item {
            text-align: center;
            padding: 1rem;
            background: var(--background-cream);
            border-radius: 8px;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-saffron);
        }

        .meta-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .temple-actions-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn-navigate {
            background: var(--success-green);
            color: white;
        }

        .action-btn-call {
            background: var(--primary-saffron);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .action-card {
                padding: 1.5rem;
            }
            
            .action-card i {
                font-size: 2.5rem;
            }
            
            .temple-grid {
                grid-template-columns: 1fr;
            }
            
            .temple-card {
                margin-bottom: 1rem;
            }
            
            .temple-header {
                padding: 1rem;
            }
            
            .temple-name {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .temple-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .filters {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .filter-btn {
                white-space: nowrap;
                min-width: max-content;
            }
            
            .temple-actions-detail {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .action-btn {
                padding: 0.875rem;
                font-size: 0.95rem;
            }
            
            .temple-detail-header {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .temple-detail-title {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            .temple-meta {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .meta-item {
                padding: 0.75rem;
            }
            
            .settings-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .circuit-card {
                padding: 1.5rem;
            }
            
            .circuit-title {
                font-size: 1.1rem;
                line-height: 1.3;
            }
            
            .circuit-temple-item {
                padding: 0.75rem;
            }
            
            .header-content {
                padding: 0 0.5rem;
            }
            
            .container {
                padding: 0 0.75rem;
            }
            
            .search-container {
                max-width: 100%;
                margin: 0;
            }
            
            .map-container {
                height: 300px;
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .temple-meta {
                grid-template-columns: 1fr;
            }
            
            .hero h1 {
                font-size: 1.75rem;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .action-card {
                padding: 1.25rem;
            }
        }

        /* Festival Calendar Styles */
        .festival-card {
            background: var(--card-white);
            border-left: 4px solid var(--primary-saffron);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .festival-date {
            color: var(--primary-saffron);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .festival-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .festival-temples {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Tour Circuit Detail */
        .circuit-detail {
            max-width: 800px;
            margin: 0 auto;
        }

        .circuit-overview {
            background: var(--card-white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .circuit-temples-list {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .circuit-temple-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .circuit-temple-item:hover {
            background: var(--background-cream);
        }

        .circuit-temple-item:last-child {
            border-bottom: none;
        }

        .temple-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-saffron);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
        }

        /* Settings Screen */
        .settings-section {
            background: var(--card-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border-light);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: var(--primary-saffron);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        /* Location Status Indicators */
        .location-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .location-available {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
        }

        .location-unavailable {
            background: rgba(158, 158, 158, 0.1);
            color: #9E9E9E;
        }

        /* Crowd Indicator */
        .crowd-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: var(--background-cream);
        }

        .crowd-low { color: var(--success-green); }
        .crowd-medium { color: var(--warning-orange); }
        .crowd-high { color: var(--error-red); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-om"></i>
                <span id="app-title">Temple Calendar</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-ghost" id="language-toggle">
                    <i class="fas fa-language"></i>
                    <span id="lang-text">தமிழ்</span>
                </button>
                <button class="btn btn-ghost" id="location-btn">
                    <i class="fas fa-location-dot"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero">
                <h1 id="hero-title">Discover Sacred Temples</h1>
                <p id="hero-subtitle">Find temples, plan pilgrimages, and explore Tamil Nadu's spiritual heritage</p>
            </section>

            <!-- Search Section -->
            <section class="search-section">
                <div class="search-container">
                    <input type="text" class="search-input" id="main-search" placeholder="Search temples...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <div class="action-card" id="nearest-action">
                    <i class="fas fa-location-arrow"></i>
                    <h3 id="nearest-title">Nearest Temples</h3>
                    <p id="nearest-desc">Discover 588 Tamil Nadu temples (127 with navigation)</p>
                </div>
                <div class="action-card" id="map-action">
                    <i class="fas fa-map"></i>
                    <h3 id="map-title">Temple Map</h3>
                    <p id="map-desc">Explore temples on interactive map</p>
                </div>
                <div class="action-card" id="tours-action">
                    <i class="fas fa-route"></i>
                    <h3 id="tours-title">Tour Circuits</h3>
                    <p id="tours-desc">Sacred journey routes</p>
                </div>
                <div class="action-card" id="festivals-action">
                    <i class="fas fa-calendar-alt"></i>
                    <h3 id="festivals-title">Festivals</h3>
                    <p id="festivals-desc">Tamil calendar events</p>
                </div>
            </section>

            <!-- Nearest Temples -->
            <section class="nearest-temples">
                <div class="section-header">
                    <h2 class="section-title" id="nearby-section-title">Nearby Temples</h2>
                    <button class="btn btn-secondary" id="view-all-nearby">View All</button>
                </div>
                <div class="temple-grid" id="nearby-temples-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Finding nearby temples...</span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Discovery Screen -->
    <div id="discovery-screen" class="screen">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title" id="discovery-title">Temple Discovery</h2>
                <div class="map-toggle">
                    <button class="btn btn-secondary" id="list-view-btn">
                        <i class="fas fa-list"></i> List
                    </button>
                    <button class="btn btn-primary" id="map-view-btn">
                        <i class="fas fa-map"></i> Map
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All Temples</button>
                <button class="filter-btn" data-filter="location">With Location 📍</button>
                <button class="filter-btn" data-filter="shiva">Shiva</button>
                <button class="filter-btn" data-filter="vishnu">Vishnu</button>
                <button class="filter-btn" data-filter="hanuman">Hanuman</button>
                <button class="filter-btn" data-filter="goddess">Goddess</button>
            </div>

            <!-- Map Container -->
            <div class="map-container" id="temple-map" style="display: none;">
                <!-- Leaflet map will be initialized here -->
            </div>

            <!-- Temple List -->
            <div class="temple-grid" id="discovery-temples-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading temples...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Temple Detail Screen -->
    <div id="temple-detail-screen" class="screen">
        <div class="container">
            <div class="temple-detail">
                <div class="temple-detail-header">
                    <h1 class="temple-detail-title" id="temple-detail-name">Temple Name</h1>
                    <p class="temple-detail-subtitle" id="temple-detail-location">Location</p>
                    
                    <div class="temple-meta">
                        <div class="meta-item">
                            <div class="meta-value" id="temple-rating">4.5</div>
                            <div class="meta-label">Rating</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-value" id="temple-distance">2.3 km</div>
                            <div class="meta-label">Distance</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-value" id="temple-deity">Shiva</div>
                            <div class="meta-label">Deity</div>
                        </div>
                    </div>
                </div>

                <div class="temple-actions-detail">
                    <button class="action-btn action-btn-navigate" id="navigate-btn">
                        <i class="fas fa-directions"></i>
                        Navigate
                    </button>
                    <button class="action-btn action-btn-call" id="call-btn">
                        <i class="fas fa-phone"></i>
                        Call Temple
                    </button>
                </div>

                <div class="temple-detail-content">
                    <div class="settings-section">
                        <h3>Temple Information</h3>
                        <div id="temple-address"></div>
                        <div id="temple-location-status"></div>
                        <div id="temple-crowd-info"></div>
                        <div id="temple-timings"></div>
                        <div id="temple-website"></div>
                    </div>
                    
                    <div class="settings-section" id="tamil-name-section" style="display: none;">
                        <h3>Tamil Name</h3>
                        <div id="temple-tamil-name" class="tamil" style="font-size: 1.2rem; font-weight: 600;"></div>
                    </div>

                    <div class="settings-section" id="popular-times-section" style="display: none;">
                        <h3>Popular Times</h3>
                        <div id="temple-popular-times"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tours Screen -->
    <div id="tours-screen" class="screen">
        <div class="container">
            <h2 class="section-title" id="tours-section-title">Sacred Tour Circuits</h2>
            <div id="tour-circuits-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading tour circuits...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tour Detail Screen -->
    <div id="tour-detail-screen" class="screen">
        <div class="container">
            <div class="circuit-detail">
                <div class="circuit-overview">
                    <h1 id="circuit-name">Circuit Name</h1>
                    <p id="circuit-description">Circuit Description</p>
                    <div class="circuit-meta">
                        <span><i class="fas fa-map-marked-alt"></i> <span id="circuit-temples-count">0</span> Temples</span>
                        <span><i class="fas fa-route"></i> <span id="circuit-distance">0</span> km</span>
                        <span><i class="fas fa-clock"></i> <span id="circuit-duration">0</span> hours</span>
                    </div>
                    <button class="btn btn-primary mt-2" id="start-circuit-btn">
                        <i class="fas fa-play"></i>
                        Start Circuit
                    </button>
                </div>
                <div class="circuit-temples-list">
                    <h3>Temples in Circuit</h3>
                    <div id="circuit-temples-container">
                        <!-- Circuit temples will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Festivals Screen -->
    <div id="festivals-screen" class="screen">
        <div class="container">
            <h2 class="section-title" id="festivals-section-title">Festival Calendar</h2>
            <div id="festivals-list">
                <div class="festival-card">
                    <div class="festival-date">Today</div>
                    <div class="festival-name">Thai Pusam</div>
                    <div class="festival-temples">Celebrated at Murugan temples</div>
                </div>
                <div class="festival-card">
                    <div class="festival-date">Tomorrow</div>
                    <div class="festival-name">Maha Shivaratri</div>
                    <div class="festival-temples">Special prayers at all Shiva temples</div>
                </div>
                <div class="festival-card">
                    <div class="festival-date">This Weekend</div>
                    <div class="festival-name">Panguni Uthiram</div>
                    <div class="festival-temples">Major celebration at Meenakshi Temple</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
        <div class="container">
            <h2 class="section-title" id="settings-section-title">Settings</h2>
            
            <div class="settings-section">
                <h3>Language & Region</h3>
                <div class="settings-item">
                    <div>
                        <div>App Language</div>
                        <small>Tamil / English</small>
                    </div>
                    <div class="toggle" id="language-setting">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Location & Navigation</h3>
                <div class="settings-item">
                    <div>
                        <div>Location Services</div>
                        <small>Find nearby temples</small>
                    </div>
                    <div class="toggle active" id="location-setting">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div>
                        <div>GPS Navigation</div>
                        <small>Open in Google Maps</small>
                    </div>
                    <div class="toggle active" id="navigation-setting">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Notifications</h3>
                <div class="settings-item">
                    <div>
                        <div>Festival Alerts</div>
                        <small>Upcoming temple festivals</small>
                    </div>
                    <div class="toggle active" id="festival-notifications">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-screen="home-screen">
            <i class="fas fa-home"></i>
            <span id="nav-home">Home</span>
        </a>
        <a href="#" class="nav-item" data-screen="discovery-screen">
            <i class="fas fa-search"></i>
            <span id="nav-discover">Discover</span>
        </a>
        <a href="#" class="nav-item" data-screen="tours-screen">
            <i class="fas fa-route"></i>
            <span id="nav-tours">Tours</span>
        </a>
        <a href="#" class="nav-item" data-screen="festivals-screen">
            <i class="fas fa-calendar"></i>
            <span id="nav-festivals">Festivals</span>
        </a>
        <a href="#" class="nav-item" data-screen="settings-screen">
            <i class="fas fa-cog"></i>
            <span id="nav-settings">Settings</span>
        </a>
    </nav>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global App State
        const AppState = {
            temples: [],
            tourCircuits: [],
            currentLocation: { lat: 13.0827, lng: 80.2707 }, // Chennai default
            currentLanguage: 'en',
            currentScreen: 'home-screen',
            currentTemple: null,
            currentCircuit: null,
            map: null,
            userLocation: null
        };

        // Translation Dictionary
        const translations = {
            en: {
                'app-title': 'Temple Calendar',
                'hero-title': 'Discover Sacred Temples',
                'hero-subtitle': 'Find temples, plan pilgrimages, and explore Tamil Nadu\'s spiritual heritage',
                'nearest-title': 'Nearest Temples',
                'nearest-desc': 'Discover 588 Tamil Nadu temples (127 with navigation)',
                'map-title': 'Temple Map',
                'map-desc': 'Explore temples on interactive map',
                'tours-title': 'Tour Circuits',
                'tours-desc': 'Sacred journey routes',
                'festivals-title': 'Festivals',
                'festivals-desc': 'Tamil calendar events',
                'nearby-section-title': 'Nearby Temples',
                'discovery-title': 'Temple Discovery',
                'tours-section-title': 'Sacred Tour Circuits',
                'festivals-section-title': 'Festival Calendar',
                'settings-section-title': 'Settings',
                'nav-home': 'Home',
                'nav-discover': 'Discover',
                'nav-tours': 'Tours',
                'nav-festivals': 'Festivals',
                'nav-settings': 'Settings',
                'lang-text': 'தமிழ்'
            },
            ta: {
                'app-title': 'கோயில் நாட்காட்டி',
                'hero-title': 'புனித கோயில்களை கண்டறியுங்கள்',
                'hero-subtitle': 'கோயில்களை கண்டறிந்து, புனித பயணங்களை திட்டமிடுங்கள்',
                'nearest-title': 'அருகிலுள்ள கோயில்கள்',
                'nearest-desc': 'உங்கள் இருப்பிடத்திற்கு அருகில் உள்ள கோயில்கள்',
                'map-title': 'கோயில் வரைபடம்',
                'map-desc': 'வரைபடத்தில் கோயில்களை ஆராயுங்கள்',
                'tours-title': 'சுற்றுலா பாதைகள்',
                'tours-desc': 'புனித பயண வழிகள்',
                'festivals-title': 'திருவிழாக்கள்',
                'festivals-desc': 'தமிழ் நாட்காட்டி நிகழ்வுகள்',
                'nearby-section-title': 'அருகிலுள்ள கோயில்கள்',
                'discovery-title': 'கோயில் கண்டுபிடிப்பு',
                'tours-section-title': 'புனித சுற்றுலா பாதைகள்',
                'festivals-section-title': 'திருவிழா நாட்காட்டி',
                'settings-section-title': 'அமைப்புகள்',
                'nav-home': 'முகப்பு',
                'nav-discover': 'கண்டறிதல்',
                'nav-tours': 'சுற்றுலா',
                'nav-festivals': 'திருவிழாக்கள்',
                'nav-settings': 'அமைப்புகள்',
                'lang-text': 'English'
            }
        };

        // Utility Functions
        function $(id) {
            return document.getElementById(id);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(km) {
            if (km < 1) {
                return `${Math.round(km * 1000)}m`;
            }
            return `${km.toFixed(1)}km`;
        }

        // Language Management
        function updateLanguage(lang) {
            AppState.currentLanguage = lang;
            localStorage.setItem('preferred-language', lang);
            
            // Update all translatable elements
            Object.keys(translations[lang]).forEach(key => {
                const element = $(key);
                if (element) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update body class for Tamil font
            if (lang === 'ta') {
                document.body.classList.add('tamil');
            } else {
                document.body.classList.remove('tamil');
            }
            
            // Refresh temple displays to show names in selected language
            if (AppState.currentScreen === 'home-screen') {
                loadNearbyTemples();
            } else if (AppState.currentScreen === 'discovery-screen') {
                loadDiscoveryTemples();
            }
            
            // Update current temple detail if showing
            if (AppState.currentScreen === 'temple-detail-screen' && AppState.currentTemple) {
                showTempleDetail(AppState.currentTemple.id);
            }
        }

        // Location Services
        function requestLocation() {
            if ('geolocation' in navigator) {
                $('location-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        AppState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        AppState.currentLocation = AppState.userLocation;
                        $('location-btn').innerHTML = '<i class="fas fa-location-dot"></i>';
                        $('location-btn').style.color = 'var(--success-green)';
                        
                        // Refresh nearby temples
                        loadNearbyTemples();
                    },
                    (error) => {
                        console.warn('Location access denied:', error);
                        $('location-btn').innerHTML = '<i class="fas fa-location-slash"></i>';
                        $('location-btn').style.color = 'var(--error-red)';
                    }
                );
            }
        }

        // Temple Data Loading
        async function loadTempleData() {
            try {
                showLoading($('nearby-temples-grid'), 'Loading temple database...');
                
                const response = await fetch('./temple_data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.app_temples) {
                    throw new Error('Invalid temple data format');
                }
                
                AppState.temples = data.app_temples || [];
                AppState.tourCircuits = data.tour_circuits || [];
                
                console.log(`Successfully loaded ${AppState.temples.length} temples and ${AppState.tourCircuits.length} circuits`);
                
                if (AppState.temples.length === 0) {
                    showError('No temple data available', $('nearby-temples-grid'));
                    return;
                }
                
                // Show success toast
                showToast(`Loaded ${AppState.temples.length} temples successfully!`, 'success');
                
                // Initial load of nearby temples
                loadNearbyTemples();
                loadTourCircuits();
                
            } catch (error) {
                console.error('Failed to load temple data:', error);
                const errorMessage = error.message.includes('fetch') ? 
                    'Unable to connect to temple database. Please check your internet connection.' :
                    `Error loading temple data: ${error.message}`;
                
                showError(errorMessage, $('nearby-temples-grid'));
                showError(errorMessage, $('tour-circuits-list'));
                showToast('Failed to load temple data', 'error');
            }
        }

        // Screen Management
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            $(screenId).classList.add('active');
            AppState.currentScreen = screenId;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-screen="${screenId}"]`).classList.add('active');
            
            // Screen-specific initialization
            if (screenId === 'discovery-screen') {
                loadDiscoveryTemples();
            } else if (screenId === 'tours-screen') {
                loadTourCircuits();
            }
        }

        // Temple Rendering
        function createTempleCard(temple, showDistance = true) {
            const distance = AppState.currentLocation ? 
                calculateDistance(
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng,
                    temple.latitude,
                    temple.longitude
                ) : null;

            const hasLocation = temple.latitude && temple.longitude;
            const locationIndicator = hasLocation ? 
                '<span class="location-indicator location-available"><i class="fas fa-navigation"></i> Navigation</span>' :
                '<span class="location-indicator location-unavailable"><i class="fas fa-times-circle"></i> No Location</span>';

            // Determine current display name based on language setting
            const displayName = AppState.currentLanguage === 'ta' && temple.tamil_name ? temple.tamil_name : temple.name;
            const nameClass = AppState.currentLanguage === 'ta' ? 'tamil' : '';
            
            // Get crowd level if available
            let crowdInfo = '';
            if (temple.popular_times && temple.popular_times.length > 0) {
                const now = new Date();
                const hour = now.getHours();
                const currentTimeEntry = temple.popular_times.find(entry => {
                    const entryHour = parseHourFromPopularTime(entry);
                    return entryHour === hour;
                });
                
                if (currentTimeEntry) {
                    const percentage = parseInt(currentTimeEntry.match(/\d+/)[0]);
                    const crowdLevel = percentage >= 40 ? 'High' : percentage >= 20 ? 'Medium' : 'Low';
                    const crowdColor = percentage >= 40 ? 'var(--error-red)' : percentage >= 20 ? 'var(--warning-orange)' : 'var(--success-green)';
                    crowdInfo = `<span style="color: ${crowdColor}; font-size: 0.75rem;"><i class="fas fa-users"></i> ${crowdLevel}</span>`;
                }
            }

            return `
                <div class="temple-card" onclick="showTempleDetail('${temple.id}')">
                    <div class="temple-header">
                        <div class="temple-name ${nameClass}">${displayName}</div>
                        <div class="temple-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${temple.district}
                        </div>
                        ${temple.gm_address && temple.gm_address !== temple.district ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; line-height: 1.3;">${temple.gm_address.length > 50 ? temple.gm_address.substring(0, 50) + '...' : temple.gm_address}</div>` : ''}
                    </div>
                    <div class="temple-info">
                        <div class="rating">
                            <i class="fas fa-star"></i>
                            ${temple.gm_rating || 'N/A'}
                        </div>
                        <div class="distance">
                            ${distance && showDistance ? formatDistance(distance) : ''}
                        </div>
                    </div>
                    <div class="temple-actions" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; justify-content: space-between;">
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            ${locationIndicator}
                            <span style="color: var(--text-secondary); text-transform: capitalize; font-size: 0.85rem;">${temple.deity_type || 'Temple'}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            ${temple.gm_phone ? `<span style="color: var(--success-green); font-size: 0.75rem;"><i class="fas fa-phone"></i></span>` : ''}
                            ${crowdInfo}
                        </div>
                    </div>
                </div>
            `;
        }

        function loadNearbyTemples() {
            const container = $('nearby-temples-grid');
            
            if (AppState.temples.length === 0) {
                showLoading(container, 'Finding temples near you...');
                return;
            }

            // Sort temples by distance if location is available
            let nearbyTemples = [...AppState.temples];
            
            if (AppState.currentLocation) {
                nearbyTemples = nearbyTemples
                    .map(temple => ({
                        ...temple,
                        distance: temple.latitude && temple.longitude ? 
                            calculateDistance(
                                AppState.currentLocation.lat,
                                AppState.currentLocation.lng,
                                temple.latitude,
                                temple.longitude
                            ) : Infinity
                    }))
                    .sort((a, b) => a.distance - b.distance);
            }

            // Show first 6 temples
            const templeHTML = nearbyTemples
                .slice(0, 6)
                .map(temple => createTempleCard(temple))
                .join('');

            container.innerHTML = templeHTML;
        }

        function loadDiscoveryTemples() {
            const container = $('discovery-temples-grid');
            const activeFilterBtn = document.querySelector('.filter-btn.active');
            
            if (!activeFilterBtn) {
                showError('Filter selection error', container);
                return;
            }
            
            const activeFilter = activeFilterBtn.dataset.filter;
            
            let filteredTemples = [...AppState.temples];
            
            // Apply filters
            if (activeFilter !== 'all') {
                if (activeFilter === 'location') {
                    filteredTemples = filteredTemples.filter(temple => 
                        temple.latitude && temple.longitude
                    );
                } else {
                    filteredTemples = filteredTemples.filter(temple => 
                        temple.deity_type === activeFilter
                    );
                }
            }

            // Sort by distance if location available
            if (AppState.currentLocation) {
                filteredTemples = filteredTemples
                    .map(temple => ({
                        ...temple,
                        distance: temple.latitude && temple.longitude ? 
                            calculateDistance(
                                AppState.currentLocation.lat,
                                AppState.currentLocation.lng,
                                temple.latitude,
                                temple.longitude
                            ) : Infinity
                    }))
                    .sort((a, b) => a.distance - b.distance);
            }

            const templeHTML = filteredTemples
                .slice(0, 50) // Limit to 50 temples for performance
                .map(temple => createTempleCard(temple))
                .join('');

            container.innerHTML = templeHTML || '<div class="text-center" style="padding: 3rem;">No temples found matching your criteria.</div>';
        }

        // Temple Detail View
        function showTempleDetail(templeId) {
            const temple = AppState.temples.find(t => t.id === templeId);
            if (!temple) return;

            AppState.currentTemple = temple;

            // Update temple details
            $('temple-detail-name').textContent = temple.name;
            $('temple-detail-location').textContent = temple.district;
            $('temple-rating').textContent = temple.gm_rating || 'N/A';
            $('temple-deity').textContent = temple.deity_type ? temple.deity_type.charAt(0).toUpperCase() + temple.deity_type.slice(1) : 'Temple';

            // Calculate and show distance
            if (AppState.currentLocation && temple.latitude && temple.longitude) {
                const distance = calculateDistance(
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng,
                    temple.latitude,
                    temple.longitude
                );
                $('temple-distance').textContent = formatDistance(distance);
            } else {
                $('temple-distance').textContent = 'N/A';
            }

            // Update address and contact info
            let addressHTML = `<p><i class="fas fa-map-marker-alt"></i> ${temple.gm_address || temple.district}</p>`;
            if (temple.gm_phone) {
                addressHTML += `<p style="margin-top: 0.5rem;"><i class="fas fa-phone" style="color: var(--success-green);"></i> <a href="tel:${temple.gm_phone}" style="color: var(--success-green); text-decoration: none;">${temple.gm_phone}</a></p>`;
            }
            $('temple-address').innerHTML = addressHTML;

            // Update location status
            const hasLocation = temple.latitude && temple.longitude;
            $('temple-location-status').innerHTML = hasLocation ?
                '<div class="location-indicator location-available"><i class="fas fa-map-marker-alt"></i> Location Available</div>' :
                '<div class="location-indicator location-unavailable"><i class="fas fa-times-circle"></i> No Location Available - Coming Soon</div>';
            
            // Show/hide action buttons based on data availability
            const navigateBtn = $('navigate-btn');
            const callBtn = $('call-btn');
            const actionsContainer = document.querySelector('.temple-actions-detail');
            
            // Show/hide navigation button
            if (hasLocation) {
                navigateBtn.style.display = 'flex';
            } else {
                navigateBtn.style.display = 'none';
            }
            
            // Show/hide call button
            if (temple.gm_phone) {
                callBtn.style.display = 'flex';
                callBtn.innerHTML = '<i class="fas fa-phone"></i> Call Temple';
            } else {
                callBtn.style.display = 'flex';
                callBtn.innerHTML = '<i class="fas fa-phone"></i> No Phone';
                callBtn.style.opacity = '0.5';
                callBtn.style.cursor = 'not-allowed';
            }
            
            // Adjust grid based on visible buttons
            const buttonsVisible = (hasLocation ? 1 : 0) + (temple.gm_phone ? 1 : 0);
            if (actionsContainer) {
                if (buttonsVisible === 2) {
                    actionsContainer.style.gridTemplateColumns = '1fr 1fr';
                } else if (buttonsVisible === 1) {
                    actionsContainer.style.gridTemplateColumns = '1fr';
                } else {
                    actionsContainer.style.display = 'none';
                }
            }

            // Show Tamil name if available
            if (temple.tamil_name && temple.tamil_name !== temple.name + ' கோவில்') {
                $('temple-tamil-name').textContent = temple.tamil_name;
                $('tamil-name-section').style.display = 'block';
            } else {
                $('tamil-name-section').style.display = 'none';
            }

            // Update website if available
            if (temple.gm_website) {
                $('temple-website').innerHTML = `<p style="margin-top: 0.5rem;"><i class="fas fa-globe" style="color: var(--primary-saffron);"></i> <a href="${temple.gm_website}" target="_blank" style="color: var(--primary-saffron); text-decoration: none;">Visit Website</a></p>`;
            } else {
                $('temple-website').innerHTML = '';
            }

            // Enhanced crowd info with popular times analysis
            if (temple.popular_times && temple.popular_times.length > 0) {
                const now = new Date();
                const hour = now.getHours();
                
                // Parse popular times to get actual crowd percentages
                let currentCrowdLevel = 'Low';
                let currentPercentage = 0;
                let crowdClass = 'crowd-low';
                
                // Find crowd level for current hour
                const currentTimeEntry = temple.popular_times.find(entry => {
                    const entryHour = parseHourFromPopularTime(entry);
                    return entryHour === hour;
                });
                
                if (currentTimeEntry) {
                    currentPercentage = parseInt(currentTimeEntry.match(/\d+/)[0]);
                    if (currentPercentage >= 40) {
                        currentCrowdLevel = 'High';
                        crowdClass = 'crowd-high';
                    } else if (currentPercentage >= 20) {
                        currentCrowdLevel = 'Medium';
                        crowdClass = 'crowd-medium';
                    }
                }

                let crowdHTML = `
                    <div class="crowd-indicator ${crowdClass}">
                        <i class="fas fa-users"></i>
                        <span>Current crowd level: ${currentCrowdLevel}</span>
                        ${currentPercentage > 0 ? `<span style="margin-left: 0.5rem; opacity: 0.8;">(${currentPercentage}% busy)</span>` : ''}
                    </div>
                `;

                // Add popular times chart
                crowdHTML += '<div style="margin-top: 1rem;"><h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">Today\'s Popular Times</h4>';
                crowdHTML += '<div style="display: flex; gap: 2px; margin-top: 0.5rem;">';
                
                for (let i = 6; i <= 20; i++) {
                    const timeEntry = temple.popular_times.find(entry => parseHourFromPopularTime(entry) === i);
                    const percentage = timeEntry ? parseInt(timeEntry.match(/\d+/)[0]) : 0;
                    const height = Math.max(percentage, 5); // Minimum height for visibility
                    const isCurrentHour = i === hour;
                    
                    crowdHTML += `
                        <div style="
                            width: 20px; 
                            height: ${height * 0.8}px; 
                            background: ${isCurrentHour ? 'var(--primary-saffron)' : percentage >= 40 ? 'var(--error-red)' : percentage >= 20 ? 'var(--warning-orange)' : 'var(--success-green)'}; 
                            border-radius: 2px 2px 0 0;
                            position: relative;
                            ${isCurrentHour ? 'box-shadow: 0 0 4px rgba(255, 107, 53, 0.5);' : ''}
                        " title="${i}:00 - ${percentage}% busy">
                            <div style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--text-secondary);">${i}</div>
                        </div>
                    `;
                }
                crowdHTML += '</div></div>';

                $('temple-crowd-info').innerHTML = crowdHTML;
                $('popular-times-section').style.display = 'block';
            } else {
                $('temple-crowd-info').innerHTML = '';
                $('popular-times-section').style.display = 'none';
            }

            // Update timings info (general temple hours)
            $('temple-timings').innerHTML = `
                <p style="margin-top: 0.5rem;"><i class="fas fa-clock" style="color: var(--warning-orange);"></i> <span style="color: var(--text-secondary);">Typical Hours: 6:00 AM - 12:00 PM, 4:00 PM - 9:00 PM</span></p>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 1.2rem;">*Hours may vary. Please call temple for exact timings.</p>
            `;

            showScreen('temple-detail-screen');
        }

        // Helper function to parse hour from popular times string
        function parseHourFromPopularTime(timeString) {
            const timeMatch = timeString.match(/(\d+)\s*(am|pm)/);
            if (!timeMatch) return -1;
            
            let hour = parseInt(timeMatch[1]);
            const period = timeMatch[2];
            
            if (period === 'pm' && hour !== 12) hour += 12;
            if (period === 'am' && hour === 12) hour = 0;
            
            return hour;
        }

        // Navigation Functions
        function navigateToTemple() {
            const temple = AppState.currentTemple;
            if (!temple || !temple.latitude || !temple.longitude) {
                alert('Location not available for this temple');
                return;
            }

            const url = `https://www.google.com/maps/dir/?api=1&destination=${temple.latitude},${temple.longitude}&travelmode=driving`;
            window.open(url, '_blank');
        }

        function callTemple() {
            const temple = AppState.currentTemple;
            if (!temple || !temple.gm_phone) {
                alert('Contact information not available for this temple yet. Please check back later.');
                return;
            }

            window.location.href = `tel:${temple.gm_phone}`;
        }

        // Tour Circuit Functions
        function loadTourCircuits() {
            const container = $('tour-circuits-list');
            
            if (AppState.tourCircuits.length === 0) {
                showLoading(container, 'Loading sacred tour circuits...');
                return;
            }

            const circuitHTML = AppState.tourCircuits.map(circuit => `
                <div class="circuit-card" onclick="showTourDetail('${circuit.id}')">
                    <div class="circuit-header">
                        <div>
                            <div class="circuit-title">${circuit.name}</div>
                            <div class="circuit-title tamil" style="font-size: 1rem; opacity: 0.9; margin-top: 0.25rem;">${circuit.tamil_name}</div>
                        </div>
                    </div>
                    <p style="margin: 1rem 0; opacity: 0.9;">${circuit.description}</p>
                    <div class="circuit-meta">
                        <span><i class="fas fa-map-marked-alt"></i> ${circuit.total_temples} Temples</span>
                        <span><i class="fas fa-route"></i> ${circuit.total_distance_km}km</span>
                        <span><i class="fas fa-clock"></i> ${circuit.estimated_hours}h</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = circuitHTML;
        }

        function showTourDetail(circuitId) {
            const circuit = AppState.tourCircuits.find(c => c.id === circuitId);
            if (!circuit) return;

            AppState.currentCircuit = circuit;

            // Update circuit details
            const displayName = AppState.currentLanguage === 'ta' && circuit.tamil_name ? circuit.tamil_name : circuit.name;
            $('circuit-name').textContent = displayName;
            $('circuit-description').textContent = circuit.description;
            $('circuit-temples-count').textContent = circuit.total_temples;
            $('circuit-distance').textContent = circuit.total_distance_km;
            $('circuit-duration').textContent = circuit.estimated_hours;

            // Load related temples based on circuit type
            const circuitTemplesContainer = $('circuit-temples-container');
            let relevantTemples = [];
            
            // Find temples that match the circuit type
            if (circuit.circuit_type === 'navagraha') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.name.toLowerCase().includes('navagraha') ||
                    temple.name.toLowerCase().includes('surya') ||
                    temple.name.toLowerCase().includes('chandra') ||
                    temple.name.toLowerCase().includes('angaraka') ||
                    temple.name.toLowerCase().includes('budha') ||
                    temple.name.toLowerCase().includes('guru') ||
                    temple.name.toLowerCase().includes('shukra') ||
                    temple.name.toLowerCase().includes('shani') ||
                    temple.name.toLowerCase().includes('rahu') ||
                    temple.name.toLowerCase().includes('ketu')
                ).slice(0, 9);
            } else if (circuit.circuit_type === 'murugan') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.deity_type === 'murugan' || 
                    temple.name.toLowerCase().includes('murugan') ||
                    temple.name.toLowerCase().includes('kartikeya') ||
                    temple.name.toLowerCase().includes('subrahmanya')
                ).slice(0, 6);
            } else if (circuit.circuit_type === 'shiva') {
                relevantTemples = AppState.temples.filter(temple => 
                    temple.deity_type === 'shiva'
                ).slice(0, circuit.total_temples || 10);
            } else {
                // For other circuits, show highly rated temples of various types
                relevantTemples = AppState.temples
                    .filter(temple => temple.gm_rating && temple.gm_rating >= 4.0)
                    .sort((a, b) => (b.gm_rating || 0) - (a.gm_rating || 0))
                    .slice(0, circuit.total_temples || 8);
            }

            if (relevantTemples.length > 0) {
                let templesHTML = '';
                relevantTemples.forEach((temple, index) => {
                    const displayName = AppState.currentLanguage === 'ta' && temple.tamil_name ? temple.tamil_name : temple.name;
                    const hasLocation = temple.latitude && temple.longitude;
                    
                    templesHTML += `
                        <div class="circuit-temple-item" onclick="showTempleDetail('${temple.id}')">
                            <div class="temple-number">${index + 1}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem; ${AppState.currentLanguage === 'ta' ? 'font-family: \\'Noto Sans Tamil\\', sans-serif;' : ''}">${displayName}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; display: flex; align-items: center; gap: 1rem;">
                                    <span><i class="fas fa-map-marker-alt"></i> ${temple.district}</span>
                                    ${temple.gm_rating ? `<span><i class="fas fa-star" style="color: var(--secondary-gold);"></i> ${temple.gm_rating}</span>` : ''}
                                    ${temple.deity_type ? `<span style="text-transform: capitalize;">${temple.deity_type}</span>` : ''}
                                </div>
                                <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; align-items: center;">
                                    ${hasLocation ? '<span class="location-indicator location-available" style="font-size: 0.7rem; padding: 0.125rem 0.25rem;"><i class="fas fa-map-marker-alt"></i> Location</span>' : '<span class="location-indicator location-unavailable" style="font-size: 0.7rem; padding: 0.125rem 0.25rem;"><i class="fas fa-times-circle"></i> No Location</span>'}
                                    ${temple.gm_phone ? '<span style="color: var(--success-green); font-size: 0.7rem;"><i class="fas fa-phone"></i> Call</span>' : ''}
                                </div>
                            </div>
                            <div style="color: var(--primary-saffron);">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    `;
                });
                circuitTemplesContainer.innerHTML = templesHTML;
            } else {
                circuitTemplesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No temples found for this circuit type.</p>
                        <p style="font-size: 0.9rem;">This circuit is still being developed.</p>
                    </div>
                `;
            }

            showScreen('tour-detail-screen');
        }

        function startCircuit() {
            const circuit = AppState.currentCircuit;
            if (!circuit) return;

            alert(`Starting ${circuit.name} circuit. This feature will be available in the full version.`);
        }

        // Search Functionality
        function initializeSearch() {
            const searchInput = $('main-search');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value);
                }, 300);
            });
        }

        function performSearch(query) {
            if (!query || query.length < 2) {
                if (AppState.currentScreen === 'home-screen') {
                    loadNearbyTemples();
                }
                return;
            }

            const searchResults = AppState.temples.filter(temple => 
                temple.name.toLowerCase().includes(query.toLowerCase()) ||
                temple.district.toLowerCase().includes(query.toLowerCase()) ||
                (temple.deity_type && temple.deity_type.toLowerCase().includes(query.toLowerCase()))
            );

            // Show results in current context
            if (AppState.currentScreen === 'home-screen') {
                const container = $('nearby-temples-grid');
                if (searchResults.length > 0) {
                    const resultsHTML = searchResults
                        .slice(0, 6)
                        .map(temple => createTempleCard(temple))
                        .join('');
                    container.innerHTML = resultsHTML;
                } else {
                    container.innerHTML = '<div class="text-center" style="padding: 3rem;">No temples found matching your search.</div>';
                }
            } else if (AppState.currentScreen === 'discovery-screen') {
                loadDiscoveryTemples();
            }
        }

        // Map Functionality
        function initializeMap() {
            if (!AppState.map) {
                AppState.map = L.map('temple-map').setView([
                    AppState.currentLocation.lat,
                    AppState.currentLocation.lng
                ], 10);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(AppState.map);
            }

            // Clear existing markers
            AppState.map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    AppState.map.removeLayer(layer);
                }
            });

            // Add temple markers
            const templesToShow = AppState.temples.filter(temple => 
                temple.latitude && temple.longitude
            ).slice(0, 100); // Limit for performance

            templesToShow.forEach(temple => {
                L.marker([temple.latitude, temple.longitude])
                    .addTo(AppState.map)
                    .bindPopup(`
                        <strong>${temple.name}</strong><br>
                        ${temple.district}<br>
                        <em>${temple.deity_type || 'Temple'}</em><br>
                        <button onclick="showTempleDetail('${temple.id}')" class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">View Details</button>
                    `);
            });

            // Add user location marker if available
            if (AppState.userLocation) {
                L.marker([AppState.userLocation.lat, AppState.userLocation.lng])
                    .addTo(AppState.map)
                    .bindPopup('Your Location')
                    .openPopup();
            }
        }

        // Filter Functions
        function initializeFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active from all buttons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    e.target.classList.add('active');
                    // Reload temples with new filter
                    loadDiscoveryTemples();
                });
            });
        }

        // Settings Functions
        function initializeSettings() {
            const toggles = document.querySelectorAll('.toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    
                    // Handle language toggle specifically
                    if (toggle.id === 'language-setting') {
                        const newLang = toggle.classList.contains('active') ? 'ta' : 'en';
                        updateLanguage(newLang);
                    }
                });
            });
        }

        // Error Handling
        function showError(message, container = null) {
            console.error(message);
            
            const errorHTML = `
                <div style="
                    background: rgba(244, 67, 54, 0.1);
                    border: 1px solid var(--error-red);
                    color: var(--error-red);
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                    margin: 1rem 0;
                ">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                    <span>${message}</span>
                    <button onclick="location.reload()" style="
                        background: var(--error-red);
                        color: white;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 4px;
                        margin-left: 1rem;
                        cursor: pointer;
                        font-size: 0.85rem;
                    ">Retry</button>
                </div>
            `;
            
            if (container) {
                container.innerHTML = errorHTML;
            } else {
                // Show error toast
                showToast(message, 'error');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 1rem;
                background: ${type === 'error' ? 'var(--error-red)' : type === 'success' ? 'var(--success-green)' : 'var(--primary-saffron)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: var(--shadow-hover);
                z-index: 1000;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check' : 'info-circle'}" style="margin-right: 0.5rem;"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 5000);
        }
        
        function showLoading(container, message = 'Loading...') {
            container.innerHTML = `
                <div class="loading" style="min-height: 200px;">
                    <div class="spinner"></div>
                    <span>${message}</span>
                </div>
            `;
        }

        // Event Listeners
        function initializeEventListeners() {
            // Language toggle
            $('language-toggle').addEventListener('click', () => {
                const newLang = AppState.currentLanguage === 'en' ? 'ta' : 'en';
                updateLanguage(newLang);
            });

            // Location button
            $('location-btn').addEventListener('click', requestLocation);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showScreen(item.dataset.screen);
                });
            });

            // Quick actions
            $('nearest-action').addEventListener('click', () => showScreen('discovery-screen'));
            $('map-action').addEventListener('click', () => {
                showScreen('discovery-screen');
                setTimeout(() => {
                    $('map-view-btn').click();
                }, 100);
            });
            $('tours-action').addEventListener('click', () => showScreen('tours-screen'));
            $('festivals-action').addEventListener('click', () => showScreen('festivals-screen'));

            // View toggles
            $('list-view-btn').addEventListener('click', () => {
                $('list-view-btn').classList.add('btn-primary');
                $('list-view-btn').classList.remove('btn-secondary');
                $('map-view-btn').classList.add('btn-secondary');
                $('map-view-btn').classList.remove('btn-primary');
                $('temple-map').style.display = 'none';
                $('discovery-temples-grid').style.display = 'grid';
            });

            $('map-view-btn').addEventListener('click', () => {
                $('map-view-btn').classList.add('btn-primary');
                $('map-view-btn').classList.remove('btn-secondary');
                $('list-view-btn').classList.add('btn-secondary');
                $('list-view-btn').classList.remove('btn-primary');
                $('temple-map').style.display = 'block';
                $('discovery-temples-grid').style.display = 'none';
                setTimeout(() => initializeMap(), 100);
            });

            // Temple actions
            $('navigate-btn').addEventListener('click', navigateToTemple);
            $('call-btn').addEventListener('click', callTemple);
            $('start-circuit-btn').addEventListener('click', startCircuit);

            // View all nearby
            $('view-all-nearby').addEventListener('click', () => showScreen('discovery-screen'));

            // Initialize search
            initializeSearch();
            initializeFilters();
            initializeSettings();
        }

        // App Initialization
        async function initializeApp() {
            console.log('Initializing Tamil Nadu Temple Calendar App...');
            
            // Load saved preferences
            const savedLang = localStorage.getItem('preferred-language') || 'en';
            updateLanguage(savedLang);
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Load temple data
            await loadTempleData();
            
            // Request location permission
            requestLocation();
            
            console.log('App initialization complete!');
        }

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Make functions globally available
        window.showTempleDetail = showTempleDetail;
        window.showTourDetail = showTourDetail;
    </script>
</body>
</html>